{% extends 'admin/base.html' %}

{% block title %}Test Management{% endblock %}

{% block content %}
<style>
    @import url('https://fonts.googleapis.com/css2?family=Space+Mono:wght@400;700&family=Syne:wght@400..800&family=Karla:wght@300;400;500;600;700&display=swap');

    .tests-wrapper {
        font-family: 'Karla', sans-serif;
        background: linear-gradient(135deg, #0f172a 0%, #1e293b 50%, #334155 100%);
        min-height: 100vh;
        margin: -32px;
        padding: 2rem;
        position: relative;
        overflow: hidden;
    }

    .tests-wrapper::before {
        content: '';
        position: absolute;
        top: -50%;
        right: -20%;
        width: 600px;
        height: 600px;
        background: radial-gradient(circle, rgba(59, 130, 246, 0.15) 0%, transparent 70%);
        animation: float 20s ease-in-out infinite;
        pointer-events: none;
    }

    .tests-wrapper::after {
        content: '';
        position: absolute;
        bottom: -30%;
        left: -10%;
        width: 500px;
        height: 500px;
        background: radial-gradient(circle, rgba(168, 85, 247, 0.1) 0%, transparent 70%);
        animation: float 25s ease-in-out infinite reverse;
        pointer-events: none;
    }

    @keyframes float {
        0%, 100% { transform: translate(0, 0) scale(1); }
        50% { transform: translate(30px, -30px) scale(1.1); }
    }

    .tests-header {
        position: relative;
        z-index: 2;
        margin-bottom: 3rem;
        display: flex;
        justify-content: space-between;
        align-items: center;
        animation: slideDown 0.8s ease-out;
    }

    @keyframes slideDown {
        from { opacity: 0; transform: translateY(-30px); }
        to { opacity: 1; transform: translateY(0); }
    }

    .tests-title {
        font-family: 'Syne', sans-serif;
        font-size: 3.5rem;
        font-weight: 800;
        background: linear-gradient(135deg, #60a5fa 0%, #a78bfa 50%, #ec4899 100%);
        -webkit-background-clip: text;
        -webkit-text-fill-color: transparent;
        background-clip: text;
        letter-spacing: -2px;
        margin-bottom: 0.5rem;
    }

    .tests-subtitle {
        font-family: 'Space Mono', monospace;
        font-size: 0.95rem;
        color: #94a3b8;
        letter-spacing: 1px;
        text-transform: uppercase;
    }

    .add-test-btn {
        padding: 1rem 2rem;
        background: linear-gradient(135deg, #3b82f6, #8b5cf6);
        border: none;
        border-radius: 12px;
        font-family: 'Syne', sans-serif;
        font-size: 0.95rem;
        font-weight: 600;
        color: #fff;
        cursor: pointer;
        transition: all 0.3s ease;
        display: flex;
        align-items: center;
        gap: 0.5rem;
    }

    .add-test-btn:hover {
        transform: translateY(-2px);
        box-shadow: 0 12px 40px rgba(59, 130, 246, 0.4);
    }

    .category-tabs {
        display: flex;
        gap: 1rem;
        margin-bottom: 2rem;
        position: relative;
        z-index: 2;
    }

    .tab-btn {
        padding: 0.75rem 1.75rem;
        background: rgba(15, 23, 42, 0.6);
        backdrop-filter: blur(20px);
        border: 2px solid rgba(148, 163, 184, 0.2);
        border-radius: 12px;
        font-family: 'Space Mono', monospace;
        font-size: 0.85rem;
        font-weight: 600;
        color: #94a3b8;
        cursor: pointer;
        transition: all 0.3s ease;
        text-transform: uppercase;
        letter-spacing: 1px;
    }

    .tab-btn:hover {
        border-color: #60a5fa;
        color: #60a5fa;
    }

    .tab-btn.active {
        background: linear-gradient(135deg, #3b82f6, #8b5cf6);
        border-color: transparent;
        color: #fff;
    }

    .tests-grid {
        display: grid;
        grid-template-columns: 1fr;
        gap: 2.5rem;
        position: relative;
        z-index: 2;
    }

    .test-set-card {
        background: rgba(15, 23, 42, 0.6);
        backdrop-filter: blur(20px);
        border: 1px solid rgba(148, 163, 184, 0.2);
        border-radius: 32px;
        padding: 2.5rem;
        transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
        position: relative;
    }

    .test-set-header {
        display: flex;
        justify-content: space-between;
        align-items: flex-start;
        margin-bottom: 2rem;
        padding-bottom: 1.5rem;
        border-bottom: 1px solid rgba(148, 163, 184, 0.1);
    }

    .test-set-title {
        font-family: 'Syne', sans-serif;
        font-size: 2rem;
        font-weight: 800;
        color: #f1f5f9;
        margin: 0;
    }

    .test-set-status {
        display: flex;
        gap: 1rem;
    }

    .status-badge {
        padding: 0.5rem 1rem;
        border-radius: 12px;
        font-family: 'Space Mono', monospace;
        font-size: 0.75rem;
        font-weight: 700;
        display: flex;
        align-items: center;
        gap: 0.5rem;
    }

    .status-badge.complete {
        background: rgba(16, 185, 129, 0.1);
        color: #34d399;
        border: 1px solid rgba(52, 211, 153, 0.3);
    }

    .status-badge.incomplete {
        background: rgba(239, 68, 68, 0.1);
        color: #f87171;
        border: 1px solid rgba(248, 113, 113, 0.3);
    }

    .sections-container {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 2rem;
    }

    .section-column {
        background: rgba(30, 41, 59, 0.3);
        border-radius: 24px;
        padding: 1.5rem;
        border: 1px solid rgba(148, 163, 184, 0.1);
    }

    .section-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 1.5rem;
    }

    .section-title {
        font-family: 'Syne', sans-serif;
        font-size: 1.25rem;
        font-weight: 700;
        color: #cbd5e1;
        display: flex;
        align-items: center;
        gap: 0.75rem;
    }

    .section-title i {
        color: #60a5fa;
    }

    .add-section-btn {
        padding: 0.6rem 1.2rem;
        background: rgba(59, 130, 246, 0.15);
        border: 1px solid rgba(96, 165, 250, 0.3);
        border-radius: 10px;
        color: #60a5fa;
        font-weight: 600;
        font-size: 0.85rem;
        cursor: pointer;
        transition: all 0.3s;
    }

    .add-section-btn:hover {
        background: #3b82f6;
        color: white;
    }

    .questions-list {
        display: flex;
        flex-direction: column;
        gap: 0.75rem;
        max-height: 300px;
        overflow-y: auto;
        padding-right: 0.5rem;
    }

    .question-row {
        background: rgba(15, 23, 42, 0.4);
        border: 1px solid rgba(148, 163, 184, 0.1);
        border-radius: 12px;
        padding: 1rem;
        display: flex;
        justify-content: space-between;
        align-items: center;
        transition: all 0.2s;
    }

    .question-row:hover {
        border-color: rgba(96, 165, 250, 0.3);
        background: rgba(15, 23, 42, 0.6);
    }

    .question-info {
        display: flex;
        flex-direction: column;
        gap: 0.25rem;
    }

    .question-label {
        font-family: 'Space Mono', monospace;
        font-size: 0.75rem;
        color: #60a5fa;
    }

    .question-preview {
        font-size: 0.9rem;
        color: #94a3b8;
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
        max-width: 200px;
    }

    .question-actions {
        display: flex;
        gap: 0.5rem;
    }

    .q-action-btn {
        width: 32px;
        height: 32px;
        border-radius: 8px;
        display: flex;
        align-items: center;
        justify-content: center;
        border: none;
        cursor: pointer;
        transition: all 0.2s;
        font-size: 0.85rem;
    }

    .q-action-btn.edit {
        background: rgba(59, 130, 246, 0.1);
        color: #60a5fa;
    }

    .q-action-btn.delete {
        background: rgba(239, 68, 68, 0.1);
        color: #f87171;
    }

    .q-action-btn:hover {
        transform: scale(1.1);
    }

    .q-action-btn.edit:hover { background: #3b82f6; color: white; }
    .q-action-btn.delete:hover { background: #ef4444; color: white; }

    .test-actions-main {
        display: flex;
        gap: 1rem;
    }

    @media (max-width: 1024px) {
        .sections-container {
            grid-template-columns: 1fr;
        }
    }

    .loading-state, .no-data {
        grid-column: 1 / -1;
        text-align: center;
        padding: 4rem 2rem;
        color: #64748b;
        font-family: 'Syne', sans-serif;
        font-size: 1.2rem;
    }

    .modal {
        display: none;
        position: fixed;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: rgba(0, 0, 0, 0.7);
        backdrop-filter: blur(10px);
        z-index: 1000;
        align-items: center;
        justify-content: center;
    }

    .modal.show {
        display: flex;
    }

    .modal-content {
        background: linear-gradient(135deg, #1e293b 0%, #0f172a 100%);
        border: 1px solid rgba(148, 163, 184, 0.2);
        border-radius: 28px;
        width: 95%;
        max-width: 1100px;
        max-height: 95vh;
        overflow: hidden;
        display: flex;
        flex-direction: column;
    }

    .modal-body {
        overflow-y: auto;
        padding: 0;
        flex: 1;
    }

    .test-tabs {
        display: flex;
        background: rgba(15, 23, 42, 0.4);
        padding: 0.5rem 1rem 0;
        border-bottom: 1px solid rgba(148, 163, 184, 0.1);
        gap: 0.5rem;
    }

    .test-tab-btn {
        padding: 1rem 1.5rem;
        background: transparent;
        border: none;
        border-bottom: 3px solid transparent;
        color: #94a3b8;
        font-family: 'Syne', sans-serif;
        font-weight: 700;
        cursor: pointer;
        transition: all 0.3s;
        display: flex;
        align-items: center;
        gap: 0.5rem;
    }

    .test-tab-btn:hover {
        color: #f1f5f9;
        background: rgba(255, 255, 255, 0.05);
    }

    .test-tab-btn.active {
        color: #60a5fa;
        border-bottom-color: #60a5fa;
    }

    .test-tab-btn i {
        font-size: 0.9rem;
    }

    .tab-content {
        display: none;
        padding: 2.5rem;
    }

    .tab-content.active {
        display: block;
    }

    .subject-selector, .module-selector {
        display: grid;
        grid-template-columns: repeat(2, 1fr);
        gap: 1.5rem;
        padding: 2.5rem;
    }

    .subject-card, .module-card {
        background: rgba(30, 41, 59, 0.4);
        border: 2px solid rgba(148, 163, 184, 0.2);
        border-radius: 20px;
        padding: 2rem;
        text-align: center;
        cursor: pointer;
        transition: all 0.3s ease;
    }

    .subject-card:hover, .module-card:hover {
        border-color: #60a5fa;
        background: rgba(59, 130, 246, 0.1);
        transform: translateY(-4px);
    }

    .subject-icon, .module-icon {
        width: 70px;
        height: 70px;
        border-radius: 16px;
        display: flex;
        align-items: center;
        justify-content: center;
        margin: 0 auto 1.5rem;
        color: white;
        font-size: 1.8rem;
    }

    .subject-card h4, .module-card h4 {
        font-family: 'Syne', sans-serif;
        font-size: 1.3rem;
        font-weight: 700;
        color: #f1f5f9;
        margin-bottom: 0.5rem;
    }

    .subject-card p, .module-card p {
        font-size: 0.9rem;
        color: #94a3b8;
        margin-bottom: 1rem;
    }

    .badge-info {
        display: inline-block;
        background: rgba(59, 130, 246, 0.15);
        color: #60a5fa;
        padding: 0.5rem 1rem;
        border-radius: 10px;
        font-family: 'Space Mono', monospace;
        font-size: 0.75rem;
        font-weight: 700;
        border: 1px solid rgba(96, 165, 250, 0.3);
    }

    #test-form {
        padding: 2.5rem;
    }

    .form-group {
        margin-bottom: 1.5rem;
    }

    .form-group label {
        display: block;
        font-family: 'Space Mono', monospace;
        font-size: 0.8rem;
        color: #94a3b8;
        text-transform: uppercase;
        letter-spacing: 1px;
        margin-bottom: 0.75rem;
    }

    .form-group input,
    .form-group select,
    .form-group textarea {
        width: 100%;
        padding: 1rem;
        background: rgba(30, 41, 59, 0.6);
        border: 2px solid rgba(148, 163, 184, 0.2);
        border-radius: 12px;
        font-family: 'Karla', sans-serif;
        font-size: 0.95rem;
        color: #f1f5f9;
        transition: all 0.3s ease;
    }

    .form-group input:focus,
    .form-group select:focus,
    .form-group textarea:focus {
        outline: none;
        border-color: #60a5fa;
        background: rgba(30, 41, 59, 0.8);
        box-shadow: 0 0 0 4px rgba(96, 165, 250, 0.1);
    }

    .form-row {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 1.5rem;
    }

    .questions-section {
        background: rgba(30, 41, 59, 0.4);
        border-radius: 16px;
        padding: 2rem;
        margin: 2rem 0;
        border: 1px solid rgba(148, 163, 184, 0.15);
    }

    .questions-header h4 {
        font-family: 'Syne', sans-serif;
        font-size: 1.2rem;
        color: #f1f5f9;
        display: flex;
        align-items: center;
        gap: 0.75rem;
        margin-bottom: 1.5rem;
    }

    #question-count-badge {
        font-family: 'Space Mono', monospace;
        font-weight: 400;
        color: #94a3b8;
    }

    #questions-container {
        display: flex;
        flex-direction: column;
        gap: 1.5rem;
        max-height: 400px;
        overflow-y: auto;
        padding-right: 0.5rem;
    }

    .question-item {
        background: rgba(15, 23, 42, 0.6);
        border: 1px solid rgba(148, 163, 184, 0.2);
        border-radius: 16px;
        padding: 1.5rem;
    }

    .question-item-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 1rem;
    }

    .question-number {
        font-family: 'Syne', sans-serif;
        font-weight: 700;
        color: #60a5fa;
        font-size: 1rem;
    }

    .delete-question-btn {
        background: rgba(239, 68, 68, 0.15);
        border: 1px solid rgba(248, 113, 113, 0.3);
        color: #f87171;
        padding: 0.5rem;
        border-radius: 8px;
        cursor: pointer;
        transition: all 0.3s ease;
    }

    .delete-question-btn:hover {
        background: rgba(239, 68, 68, 0.3);
    }

    .question-text-input {
        width: 100%;
        padding: 1rem;
        background: rgba(30, 41, 59, 0.6);
        border: 2px solid rgba(148, 163, 184, 0.2);
        border-radius: 12px;
        font-family: 'Karla', sans-serif;
        font-size: 0.95rem;
        color: #f1f5f9;
        margin-bottom: 1rem;
        resize: vertical;
    }

    .question-text-input:focus {
        outline: none;
        border-color: #60a5fa;
        box-shadow: 0 0 0 4px rgba(96, 165, 250, 0.1);
    }

    .image-upload-section {
        margin-bottom: 1rem;
        padding: 1rem;
        background: rgba(30, 41, 59, 0.4);
        border-radius: 12px;
        border: 2px dashed rgba(148, 163, 184, 0.3);
    }

    .image-upload-section.has-image {
        border-style: solid;
        border-color: #34d399;
    }

    .image-upload-label {
        display: flex;
        align-items: center;
        gap: 0.75rem;
        cursor: pointer;
        color: #94a3b8;
        font-size: 0.9rem;
    }

    .image-upload-label i {
        color: #60a5fa;
    }

    .image-upload-input {
        display: none;
    }

    .image-preview {
        margin-top: 1rem;
        position: relative;
    }

    .image-preview img {
        max-width: 200px;
        max-height: 150px;
        border-radius: 12px;
    }

    .remove-image-btn {
        position: absolute;
        top: -8px;
        right: -8px;
        background: #ef4444;
        color: white;
        border: none;
        border-radius: 50%;
        width: 28px;
        height: 28px;
        cursor: pointer;
        font-size: 0.85rem;
    }

    .options-grid {
        display: grid;
        grid-template-columns: repeat(2, 1fr);
        gap: 0.75rem;
    }

    .option-item {
        display: flex;
        align-items: center;
        gap: 0.75rem;
    }

    .option-radio {
        width: 20px;
        height: 20px;
        accent-color: #34d399;
    }

    .option-label {
        font-family: 'Syne', sans-serif;
        font-weight: 700;
        color: #cbd5e1;
        min-width: 30px;
    }

    .option-input {
        flex: 1;
        padding: 0.75rem;
        background: rgba(30, 41, 59, 0.6);
        border: 2px solid rgba(148, 163, 184, 0.2);
        border-radius: 8px;
        font-family: 'Karla', sans-serif;
        font-size: 0.9rem;
        color: #f1f5f9;
    }

    .option-input:focus {
        outline: none;
        border-color: #60a5fa;
    }

    .add-question-btn {
        width: 100%;
        margin-top: 1rem;
        padding: 1rem;
        background: rgba(59, 130, 246, 0.15);
        border: 2px dashed rgba(96, 165, 250, 0.3);
        border-radius: 12px;
        font-family: 'Syne', sans-serif;
        font-size: 0.95rem;
        font-weight: 600;
        color: #60a5fa;
        cursor: pointer;
        transition: all 0.3s ease;
    }

    .add-question-btn:hover {
        background: rgba(59, 130, 246, 0.25);
        border-color: #60a5fa;
    }

    .form-actions {
        display: flex;
        justify-content: flex-end;
        gap: 1rem;
        padding-top: 2rem;
        border-top: 1px solid rgba(148, 163, 184, 0.15);
    }

    .form-actions button {
        padding: 1rem 2rem;
        border-radius: 12px;
        font-family: 'Syne', sans-serif;
        font-size: 0.95rem;
        font-weight: 600;
        cursor: pointer;
        transition: all 0.3s ease;
    }

    .form-actions .btn-secondary {
        background: rgba(100, 116, 139, 0.2);
        border: 1px solid rgba(148, 163, 184, 0.3);
        color: #94a3b8;
    }

    .form-actions .btn-secondary:hover {
        background: rgba(100, 116, 139, 0.3);
    }

    .form-actions .btn-primary {
        background: linear-gradient(135deg, #3b82f6, #8b5cf6);
        border: none;
        color: #fff;
    }

    .form-actions .btn-primary:hover {
        transform: translateY(-2px);
        box-shadow: 0 12px 40px rgba(59, 130, 246, 0.4);
    }
</style>

<div class="tests-wrapper">
    <div class="tests-header">
        <div>
            <h1 class="tests-title">Test Management</h1>
            <p class="tests-subtitle">Create & Manage SAT Tests</p>
        </div>
        <button class="add-test-btn" onclick="openSubjectSelector()">
            <i class="fas fa-plus"></i> Add New Test
        </button>
    </div>

    <div class="category-tabs">
        <button class="tab-btn active" data-category="all">All Tests</button>
    </div>

    <div class="tests-grid" id="tests-grid">
        <div class="loading-state">Loading tests...</div>
    </div>
</div>

<div id="subject-selector-modal" class="modal">
    <div class="modal-content" style="max-width: 600px;">
        <div class="modal-header">
            <h3 class="modal-title">Select Subject</h3>
            <button class="close-modal">&times;</button>
        </div>
        <div class="subject-selector">
            <div class="subject-card" onclick="selectSubject('english')">
                <div class="subject-icon" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);">
                    <i class="fas fa-book-open"></i>
                </div>
                <h4>English</h4>
                <p>Reading & Writing modules</p>
                <span class="badge-info">2 Modules • 54 Questions</span>
            </div>
            <div class="subject-card" onclick="selectSubject('math')">
                <div class="subject-icon" style="background: linear-gradient(135deg, #11998e 0%, #38ef7d 100%);">
                    <i class="fas fa-calculator"></i>
                </div>
                <h4>Math</h4>
                <p>Module 1 & Module 2</p>
                <span class="badge-info">2 Modules • 44 Questions</span>
            </div>
        </div>
    </div>
</div>

<div id="module-selector-modal" class="modal">
    <div class="modal-content" style="max-width: 600px;">
        <div class="modal-header">
            <h3 id="module-selector-title" class="modal-title">Select Module</h3>
            <button class="close-modal">&times;</button>
        </div>
        <div class="module-selector" id="module-selector-content">
        </div>
    </div>
</div>

<div id="test-modal" class="modal">
    <div class="modal-content">
        <div class="modal-header">
            <h3 id="modal-title" class="modal-title">Create / Edit Test Set</h3>
            <button class="close-modal">&times;</button>
        </div>
        <form id="test-form">
            <div class="modal-body">
                <div style="padding: 2.5rem 2.5rem 0;">
                    <input type="hidden" id="test-id">
                    
                    <div class="form-row">
                        <div class="form-group">
                            <label>Test Set Name (Shared for all 4 modules)</label>
                            <input type="text" id="test-title" required placeholder="e.g., Practice Test 1" list="existing-titles">
                            <datalist id="existing-titles"></datalist>
                            <small style="color: #94a3b8; font-size: 0.75rem; margin-top: 0.25rem; display: block;">
                                Barcha 4ta modul (Eng 1, 2, Math 1, 2) mana shu nom ostida yig'iladi.
                            </small>
                        </div>
                        <div class="form-group">
                            <label>Global Difficulty</label>
                            <select id="test-difficulty">
                                <option value="easy">Easy</option>
                                <option value="medium" selected>Medium</option>
                                <option value="hard">Hard</option>
                            </select>
                        </div>
                    </div>
                </div>

                <div class="test-tabs">
                    <button type="button" class="test-tab-btn active" data-tab="english_module1" onclick="switchTab('english_module1')">
                        <i class="fas fa-book-open"></i> Eng 1
                    </button>
                    <button type="button" class="test-tab-btn" data-tab="english_module2" onclick="switchTab('english_module2')">
                        <i class="fas fa-pen-fancy"></i> Eng 2
                    </button>
                    <button type="button" class="test-tab-btn" data-tab="math_module1" onclick="switchTab('math_module1')">
                        <i class="fas fa-calculator"></i> Math 1
                    </button>
                    <button type="button" class="test-tab-btn" data-tab="math_module2" onclick="switchTab('math_module2')">
                        <i class="fas fa-square-root-alt"></i> Math 2
                    </button>
                </div>

                <div id="english_module1_tab" class="tab-content active">
                    <div class="form-row">
                        <div class="form-group">
                            <label>Module Duration (min)</label>
                            <input type="number" class="module-duration" id="dur_english_module1" value="32">
                        </div>
                        <div class="form-group">
                            <label>Status</label>
                            <select class="module-active" id="active_english_module1">
                                <option value="true">Active</option>
                                <option value="false">Inactive</option>
                            </select>
                        </div>
                    </div>
                    <div class="questions-section">
                        <div class="questions-header">
                            <h4><i class="fas fa-list-ol"></i> English Module 1 Questions <span class="q-count-badge" id="count_english_module1">(0/27)</span></h4>
                        </div>
                        <div id="container_english_module1" class="questions-container-list"></div>
                        <button type="button" class="add-question-btn" onclick="addQuestion('english_module1')">
                            <i class="fas fa-plus"></i> Add Question to Eng 1
                        </button>
                    </div>
                </div>

                <div id="english_module2_tab" class="tab-content">
                    <div class="form-row">
                        <div class="form-group">
                            <label>Module Duration (min)</label>
                            <input type="number" class="module-duration" id="dur_english_module2" value="32">
                        </div>
                        <div class="form-group">
                            <label>Status</label>
                            <select class="module-active" id="active_english_module2">
                                <option value="true">Active</option>
                                <option value="false">Inactive</option>
                            </select>
                        </div>
                    </div>
                    <div class="questions-section">
                        <div class="questions-header">
                            <h4><i class="fas fa-list-ol"></i> English Module 2 Questions <span class="q-count-badge" id="count_english_module2">(0/27)</span></h4>
                        </div>
                        <div id="container_english_module2" class="questions-container-list"></div>
                        <button type="button" class="add-question-btn" onclick="addQuestion('english_module2')">
                            <i class="fas fa-plus"></i> Add Question to Eng 2
                        </button>
                    </div>
                </div>

                <div id="math_module1_tab" class="tab-content">
                    <div class="form-row">
                        <div class="form-group">
                            <label>Module Duration (min)</label>
                            <input type="number" class="module-duration" id="dur_math_module1" value="35">
                        </div>
                        <div class="form-group">
                            <label>Status</label>
                            <select class="module-active" id="active_math_module1">
                                <option value="true">Active</option>
                                <option value="false">Inactive</option>
                            </select>
                        </div>
                    </div>
                    <div class="questions-section">
                        <div class="questions-header">
                            <h4><i class="fas fa-list-ol"></i> Math Module 1 Questions <span class="q-count-badge" id="count_math_module1">(0/22)</span></h4>
                        </div>
                        <div id="container_math_module1" class="questions-container-list"></div>
                        <button type="button" class="add-question-btn" onclick="addQuestion('math_module1')">
                            <i class="fas fa-plus"></i> Add Question to Math 1
                        </button>
                    </div>
                </div>

                <div id="math_module2_tab" class="tab-content">
                    <div class="form-row">
                        <div class="form-group">
                            <label>Module Duration (min)</label>
                            <input type="number" class="module-duration" id="dur_math_module2" value="35">
                        </div>
                        <div class="form-group">
                            <label>Status</label>
                            <select class="module-active" id="active_math_module2">
                                <option value="true">Active</option>
                                <option value="false">Inactive</option>
                            </select>
                        </div>
                    </div>
                    <div class="questions-section">
                        <div class="questions-header">
                            <h4><i class="fas fa-list-ol"></i> Math Module 2 Questions <span class="q-count-badge" id="count_math_module2">(0/22)</span></h4>
                        </div>
                        <div id="container_math_module2" class="questions-container-list"></div>
                        <button type="button" class="add-question-btn" onclick="addQuestion('math_module2')">
                            <i class="fas fa-plus"></i> Add Question to Math 2
                        </button>
                    </div>
                </div>
            </div>

            <div class="form-actions" style="padding: 1.5rem 2.5rem; background: rgba(15, 23, 42, 0.4);">
                <button type="button" class="btn-secondary close-modal">Cancel</button>
                <button type="submit" class="btn-primary"><i class="fas fa-save"></i> Save All Modules</button>
            </div>
        </form>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
let currentCategory = 'all';
let selectedSubject = '';
let activeTab = 'english_module1';
let questionCounts = {
    'english_module1': 0,
    'english_module2': 0,
    'math_module1': 0,
    'math_module2': 0
};
const MAX_QUESTIONS = {
    'english_module1': 27,
    'english_module2': 27,
    'math_module1': 22,
    'math_module2': 22
};

document.addEventListener('DOMContentLoaded', function() {
    loadTests();
    
    document.querySelectorAll('.tab-btn').forEach(btn => {
        btn.addEventListener('click', function() {
            document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
            this.classList.add('active');
            currentCategory = this.dataset.category;
            loadTests();
        });
    });
    
    document.querySelectorAll('.close-modal').forEach(btn => {
        btn.addEventListener('click', closeAllModals);
    });
    
    document.getElementById('test-form').addEventListener('submit', saveAllModules);
});

function closeAllModals() {
    document.querySelectorAll('.modal').forEach(m => m.classList.remove('show'));
}

function switchTab(tabName) {
    activeTab = tabName;
    document.querySelectorAll('.test-tab-btn').forEach(btn => {
        btn.classList.toggle('active', btn.dataset.tab === tabName);
    });
    document.querySelectorAll('.tab-content').forEach(content => {
        content.classList.toggle('active', content.id === `${tabName}_tab`);
    });
}

function openSubjectSelector() {
    closeAllModals();
    document.getElementById('test-form').reset();
    document.getElementById('test-id').value = '';
    // Reset all containers
    Object.keys(questionCounts).forEach(m => {
        document.getElementById(`container_${m}`).innerHTML = '';
        questionCounts[m] = 0;
        updateQuestionCount(m);
    });
    
    switchTab('english_module1');
    document.getElementById('modal-title').textContent = 'Create New Test Set';
    document.getElementById('test-modal').classList.add('show');
}

function addQuestion(module) {
    if (questionCounts[module] >= MAX_QUESTIONS[module]) {
        alert(`Maximum ${MAX_QUESTIONS[module]} questions allowed for ${module}`);
        return;
    }
    
    questionCounts[module]++;
    const container = document.getElementById(`container_${module}`);
    const isMath = module.startsWith('math');
    const qNum = questionCounts[module];
    
    const questionHtml = `
        <div class="question-item" data-question="${qNum}">
            <div class="question-item-header">
                <span class="question-number">Question ${qNum}</span>
                <button type="button" class="delete-question-btn" onclick="deleteQuestion(this, '${module}')">
                    <i class="fas fa-trash"></i>
                </button>
            </div>
            <textarea class="question-text-input" placeholder="Enter question text..." rows="2" required></textarea>
            ${isMath ? `
            <div class="image-upload-section">
                <label class="image-upload-label">
                    <i class="fas fa-image"></i>
                    <span>Add image (optional)</span>
                    <input type="file" class="image-upload-input" accept="image/*" onchange="handleImageUpload(this)">
                </label>
                <div class="image-preview"></div>
            </div>
            ` : ''}
            <div class="options-grid">
                <div class="option-item">
                    <input type="radio" name="correct_${module}_${qNum}" value="A" class="option-radio" required>
                    <span class="option-label">A)</span>
                    <input type="text" class="option-input" placeholder="Option A" required>
                </div>
                <div class="option-item">
                    <input type="radio" name="correct_${module}_${qNum}" value="B" class="option-radio">
                    <span class="option-label">B)</span>
                    <input type="text" class="option-input" placeholder="Option B" required>
                </div>
                <div class="option-item">
                    <input type="radio" name="correct_${module}_${qNum}" value="C" class="option-radio">
                    <span class="option-label">C)</span>
                    <input type="text" class="option-input" placeholder="Option C" required>
                </div>
                <div class="option-item">
                    <input type="radio" name="correct_${module}_${qNum}" value="D" class="option-radio">
                    <span class="option-label">D)</span>
                    <input type="text" class="option-input" placeholder="Option D" required>
                </div>
            </div>
        </div>
    `;
    
    container.insertAdjacentHTML('beforeend', questionHtml);
    updateQuestionCount(module);
    container.scrollTop = container.scrollHeight;
}

function deleteQuestion(btn, module) {
    btn.closest('.question-item').remove();
    renumberQuestions(module);
}

function renumberQuestions(module) {
    const container = document.getElementById(`container_${module}`);
    const questions = container.querySelectorAll('.question-item');
    questionCounts[module] = questions.length;
    
    questions.forEach((q, index) => {
        const num = index + 1;
        q.dataset.question = num;
        q.querySelector('.question-number').textContent = `Question ${num}`;
        
        const radios = q.querySelectorAll('.option-radio');
        radios.forEach(radio => {
            radio.name = `correct_${module}_${num}`;
        });
    });
    
    updateQuestionCount(module);
}

function updateQuestionCount(module) {
    document.getElementById(`count_${module}`).innerHTML = `(${questionCounts[module]}/${MAX_QUESTIONS[module]})`;
}

function handleImageUpload(input) {
    const file = input.files[0];
    if (file) {
        const reader = new FileReader();
        const preview = input.closest('.image-upload-section').querySelector('.image-preview');
        const section = input.closest('.image-upload-section');
        
        reader.onload = function(e) {
            preview.innerHTML = `
                <img src="${e.target.result}" alt="Question image">
                <button type="button" class="remove-image-btn" onclick="removeImage(this)">
                    <i class="fas fa-times"></i>
                </button>
            `;
            section.classList.add('has-image');
        };
        
        reader.readAsDataURL(file);
    }
}

function removeImage(btn) {
    const section = btn.closest('.image-upload-section');
    section.querySelector('.image-preview').innerHTML = '';
    section.querySelector('.image-upload-input').value = '';
    section.classList.remove('has-image');
}

async function loadTests() {
    try {
        const response = await fetch('/api/tests/');
        const result = await response.json();
        const grid = document.getElementById('tests-grid');
        
        if (result.data.length === 0) {
            grid.innerHTML = '<div class="no-data">No tests found. Click "Add New Test" to create one.</div>';
            return;
        }

        const groups = {};
        result.data.forEach(test => {
            const titleKey = test.title.trim().toLowerCase();
            if (!groups[titleKey]) {
                groups[titleKey] = { 
                    displayTitle: test.title.trim(),
                    english_module1: null, 
                    english_module2: null,
                    math_module1: null,
                    math_module2: null
                };
            }
            groups[titleKey][test.test_type] = test;
            if (test.test_type === 'english_module1') {
                groups[titleKey].displayTitle = test.title.trim();
            }
        });

        const datalist = document.getElementById('existing-titles');
        datalist.innerHTML = Object.keys(groups).map(key => `<option value="${groups[key].displayTitle}">`).join('');

        const filteredKeys = Object.keys(groups).filter(key => {
            if (currentCategory === 'all') return true;
            const group = groups[key];
            if (currentCategory === 'english') return group.english_module1 || group.english_module2;
            if (currentCategory === 'math') return group.math_module1 || group.math_module2;
            return true;
        });

        if (filteredKeys.length === 0) {
            grid.innerHTML = '<div class="no-data">No tests found for this category.</div>';
            return;
        }
        
        grid.innerHTML = filteredKeys.map(key => {
            const group = groups[key];
            const title = group.displayTitle;
            const escapedTitle = title.replace(/'/g, "\\'").replace(/"/g, "&quot;");
            const hasE1 = !!group.english_module1;
            const hasE2 = !!group.english_module2;
            const hasM1 = !!group.math_module1;
            const hasM2 = !!group.math_module2;
            const isComplete = hasE1 && hasE2 && hasM1 && hasM2;
            
            return `
                <div class="test-set-card">
                    <div class="test-set-header">
                        <div>
                            <h3 class="test-set-title">${title}</h3>
                            <div class="test-set-status">
                                <span class="status-badge ${hasE1 ? 'complete' : 'incomplete'}">
                                    <i class="fas fa-${hasE1 ? 'check-circle' : 'circle'}"></i> Eng 1
                                </span>
                                <span class="status-badge ${hasE2 ? 'complete' : 'incomplete'}">
                                    <i class="fas fa-${hasE2 ? 'check-circle' : 'circle'}"></i> Eng 2
                                </span>
                                <span class="status-badge ${hasM1 ? 'complete' : 'incomplete'}">
                                    <i class="fas fa-${hasM1 ? 'check-circle' : 'circle'}"></i> Math 1
                                </span>
                                <span class="status-badge ${hasM2 ? 'complete' : 'incomplete'}">
                                    <i class="fas fa-${hasM2 ? 'check-circle' : 'circle'}"></i> Math 2
                                </span>
                            </div>
                        </div>
                        <div class="test-actions-main">
                            <button class="q-action-btn edit" onclick="editTestSet('${escapedTitle}')" title="Edit entire set">
                                <i class="fas fa-edit"></i>
                            </button>
                            <button class="q-action-btn delete" onclick="deleteTestSet('${escapedTitle}')" title="Delete entire set">
                                <i class="fas fa-trash-alt"></i>
                            </button>
                        </div>
                    </div>
                    
                    <div class="sections-container">
                        <div class="section-column">
                            <div class="section-header">
                                <h4 class="section-title"><i class="fas fa-book-open"></i> English</h4>
                                <button class="add-section-btn" onclick="addSpecificModule('${escapedTitle}', 'english_module1')">Add/Edit</button>
                            </div>
                            <div class="questions-list">
                                ${hasE1 ? renderModuleInfo(group.english_module1, 'Module 1') : '<p style="color: #f87171; font-size: 0.8rem;">Module 1 missing</p>'}
                                ${hasE2 ? renderModuleInfo(group.english_module2, 'Module 2') : '<p style="color: #f87171; font-size: 0.8rem;">Module 2 missing</p>'}
                            </div>
                        </div>
                        <div class="section-column">
                            <div class="section-header">
                                <h4 class="section-title"><i class="fas fa-calculator"></i> Math</h4>
                                <button class="add-section-btn" onclick="addSpecificModule('${escapedTitle}', 'math_module1')">Add/Edit</button>
                            </div>
                            <div class="questions-list">
                                ${hasM1 ? renderModuleInfo(group.math_module1, 'Module 1') : '<p style="color: #f87171; font-size: 0.8rem;">Module 1 missing</p>'}
                                ${hasM2 ? renderModuleInfo(group.math_module2, 'Module 2') : '<p style="color: #f87171; font-size: 0.8rem;">Module 2 missing</p>'}
                            </div>
                        </div>
                    </div>
                    ${isComplete ? '<p style="color: #34d399; text-align: center; margin-top: 1rem; font-weight: 600;"><i class="fas fa-check-circle"></i> Complete</p>' : '<p style="color: #f87171; text-align: center; margin-top: 1rem; font-weight: 600;"><i class="fas fa-exclamation-circle"></i> Incomplete</p>'}
                </div>
            `;
        }).join('');
    } catch (error) {
        console.error('Error loading tests:', error);
    }
}

function renderModuleInfo(test, moduleName) {
    return `
        <div class="question-row">
            <div class="question-info">
                <span class="question-label">${moduleName}</span>
                <span class="question-preview">${test.questions_count} questions • ${test.duration} min</span>
            </div>
        </div>
    `;
}

async function editTestSet(title) {
    try {
        const response = await fetch('/api/tests/');
        const result = await response.json();
        const modules = result.data.filter(t => t.title === title);
        
        openSubjectSelector();
        document.getElementById('test-title').value = title;
        document.getElementById('modal-title').textContent = `Edit Test Set: ${title}`;
        
        for (const mod of modules) {
            const type = mod.test_type;
            document.getElementById(`dur_${type}`).value = mod.duration;
            document.getElementById(`active_${type}`).value = mod.is_active.toString();
            document.getElementById('test-difficulty').value = mod.difficulty;
            
            const container = document.getElementById(`container_${type}`);
            container.innerHTML = '';
            questionCounts[type] = 0;
            
            if (mod.questions) {
                mod.questions.forEach(q => addQuestionWithData(type, q));
            }
        }
        
        document.getElementById('test-modal').classList.add('show');
    } catch (error) {
        console.error('Error editing test set:', error);
    }
}

function addQuestionWithData(module, data) {
    questionCounts[module]++;
    const container = document.getElementById(`container_${module}`);
    const isMath = module.startsWith('math');
    const qNum = questionCounts[module];
    
    const questionHtml = `
        <div class="question-item" data-question="${qNum}">
            <div class="question-item-header">
                <span class="question-number">Question ${qNum}</span>
                <button type="button" class="delete-question-btn" onclick="deleteQuestion(this, '${module}')">
                    <i class="fas fa-trash"></i>
                </button>
            </div>
            <textarea class="question-text-input" placeholder="Enter question text..." rows="2" required>${data.text || data.question_text || ''}</textarea>
            ${isMath ? `
            <div class="image-upload-section ${data.image ? 'has-image' : ''}">
                <label class="image-upload-label">
                    <i class="fas fa-image"></i>
                    <span>Add image</span>
                    <input type="file" class="image-upload-input" accept="image/*" onchange="handleImageUpload(this)">
                </label>
                <div class="image-preview">
                    ${data.image ? `<img src="${data.image}"><button type="button" class="remove-image-btn" onclick="removeImage(this)"><i class="fas fa-times"></i></button>` : ''}
                </div>
            </div>
            ` : ''}
            <div class="options-grid">
                ${['A', 'B', 'C', 'D'].map(label => {
                    const opt = data.options ? data.options.find(o => o.label === label) : null;
                    const isCorrect = data.correct_answer === label;
                    const text = opt ? opt.text : (data[`option_${label.toLowerCase()}`] || '');
                    return `
                    <div class="option-item">
                        <input type="radio" name="correct_${module}_${qNum}" value="${label}" class="option-radio" ${isCorrect ? 'checked' : ''} required>
                        <span class="option-label">${label})</span>
                        <input type="text" class="option-input" placeholder="Option ${label}" value="${text}" required>
                    </div>`;
                }).join('')}
            </div>
        </div>
    `;
    container.insertAdjacentHTML('beforeend', questionHtml);
    updateQuestionCount(module);
}

function addSpecificModule(title, module) {
    editTestSet(title).then(() => {
        switchTab(module);
    });
}

async function saveAllModules(e) {
    e.preventDefault();
    const title = document.getElementById('test-title').value.trim();
    const difficulty = document.getElementById('test-difficulty').value;
    
    const modulesToSave = ['english_module1', 'english_module2', 'math_module1', 'math_module2'];
    let savedCount = 0;
    
    for (const moduleType of modulesToSave) {
        const container = document.getElementById(`container_${moduleType}`);
        const questions = [];
        
        container.querySelectorAll('.question-item').forEach((item, idx) => {
            const qText = item.querySelector('.question-text-input').value;
            const opts = [];
            let correct = '';
            
            item.querySelectorAll('.option-item').forEach(opt => {
                const label = opt.querySelector('.option-label').textContent.replace(')', '');
                opts.push({ label: label, text: opt.querySelector('.option-input').value });
                if (opt.querySelector('.option-radio').checked) correct = label;
            });
            
            const img = item.querySelector('.image-preview img');
            questions.push({
                order: idx + 1,
                text: qText,
                options: opts,
                correct_answer: correct,
                image: img ? img.src : null
            });
        });
        
        if (questions.length === 0) continue; // Skip empty modules
        
        const data = {
            title: title,
            category: moduleType.startsWith('english') ? 'english' : 'math',
            test_type: moduleType,
            difficulty: difficulty,
            duration: parseInt(document.getElementById(`dur_${moduleType}`).value),
            questions_count: questions.length,
            questions: questions,
            is_active: document.getElementById(`active_${moduleType}`).value === 'true'
        };
        
        try {
            await fetch('/api/tests/create/', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(data)
            });
            savedCount++;
        } catch (err) {
            console.error(`Error saving ${moduleType}:`, err);
        }
    }
    
    if (savedCount > 0) {
        alert(`${savedCount} modules saved successfully!`);
        closeAllModals();
        loadTests();
    } else {
        alert('Please add at least one question to any module before saving.');
    }
}

async function deleteTestSet(title) {
    if (!confirm(`Are you sure you want to delete all tests with title "${title}"?`)) return;
    try {
        const response = await fetch('/api/tests/');
        const result = await response.json();
        const toDelete = result.data.filter(t => t.title === title);
        for (const test of toDelete) {
            await fetch(`/api/tests/${test.id}/delete/`, { method: 'DELETE' });
        }
        loadTests();
    } catch (error) {
        console.error('Error deleting test set:', error);
    }
}
</script>
{% endblock %}
