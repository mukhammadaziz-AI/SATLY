{% extends 'admin/base.html' %}

{% block title %}Test Management{% endblock %}

{% block content %}
<style>
    @import url('https://fonts.googleapis.com/css2?family=Space+Mono:wght@400;700&family=Syne:wght@400..800&family=Karla:wght@300;400;500;600;700&display=swap');

    .tests-wrapper {
        font-family: 'Karla', sans-serif;
        background: linear-gradient(135deg, #0f172a 0%, #1e293b 50%, #334155 100%);
        min-height: 100vh;
        margin: -32px;
        padding: 2rem;
        position: relative;
        overflow: hidden;
    }

    .tests-header {
        position: relative;
        z-index: 2;
        margin-bottom: 3rem;
        display: flex;
        justify-content: space-between;
        align-items: center;
    }

    .tests-title {
        font-family: 'Syne', sans-serif;
        font-size: 3.5rem;
        font-weight: 800;
        background: linear-gradient(135deg, #60a5fa 0%, #a78bfa 50%, #ec4899 100%);
        -webkit-background-clip: text;
        -webkit-text-fill-color: transparent;
        background-clip: text;
        letter-spacing: -2px;
        margin-bottom: 0.5rem;
    }

    .add-test-btn {
        padding: 1rem 2rem;
        background: linear-gradient(135deg, #3b82f6, #8b5cf6);
        border: none;
        border-radius: 12px;
        font-family: 'Syne', sans-serif;
        font-size: 0.95rem;
        font-weight: 600;
        color: #fff;
        cursor: pointer;
        transition: all 0.3s ease;
        display: flex;
        align-items: center;
        gap: 0.5rem;
    }

    .add-test-btn:hover {
        transform: translateY(-2px);
        box-shadow: 0 12px 40px rgba(59, 130, 246, 0.4);
    }

    .tests-grid {
        display: grid;
        grid-template-columns: 1fr;
        gap: 2.5rem;
        position: relative;
        z-index: 2;
    }

    .test-set-card {
        background: rgba(15, 23, 42, 0.6);
        backdrop-filter: blur(20px);
        border: 1px solid rgba(148, 163, 184, 0.2);
        border-radius: 32px;
        padding: 2.5rem;
        transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
        position: relative;
    }

    .test-set-header {
        display: flex;
        justify-content: space-between;
        align-items: flex-start;
        margin-bottom: 2rem;
        padding-bottom: 1.5rem;
        border-bottom: 1px solid rgba(148, 163, 184, 0.1);
    }

    .test-set-title {
        font-family: 'Syne', sans-serif;
        font-size: 2rem;
        font-weight: 800;
        color: #f1f5f9;
        margin: 0;
    }

    .status-badge {
        padding: 0.5rem 1rem;
        border-radius: 12px;
        font-family: 'Space Mono', monospace;
        font-size: 0.75rem;
        font-weight: 700;
        display: inline-flex;
        align-items: center;
        gap: 0.5rem;
        margin-right: 0.5rem;
    }

    .status-badge.complete { background: rgba(16, 185, 129, 0.1); color: #34d399; border: 1px solid rgba(52, 211, 153, 0.3); }
    .status-badge.incomplete { background: rgba(239, 68, 68, 0.1); color: #f87171; border: 1px solid rgba(248, 113, 113, 0.3); }

    .sections-container {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 2rem;
    }

    .section-column {
        background: rgba(30, 41, 59, 0.3);
        border-radius: 24px;
        padding: 1.5rem;
        border: 1px solid rgba(148, 163, 184, 0.1);
    }

    .section-title {
        font-family: 'Syne', sans-serif;
        font-size: 1.25rem;
        font-weight: 700;
        color: #cbd5e1;
        display: flex;
        align-items: center;
        gap: 0.75rem;
        margin-bottom: 1rem;
    }

    .module-item {
        background: rgba(15, 23, 42, 0.4);
        border: 1px solid rgba(148, 163, 184, 0.1);
        border-radius: 12px;
        padding: 1rem;
        margin-bottom: 0.75rem;
        display: flex;
        justify-content: space-between;
        align-items: center;
        cursor: pointer;
        transition: all 0.2s;
    }

    .module-item:hover { border-color: #60a5fa; background: rgba(15, 23, 42, 0.6); }

    .modal {
        display: none;
        position: fixed;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: rgba(0, 0, 0, 0.7);
        backdrop-filter: blur(10px);
        z-index: 1000;
        align-items: center;
        justify-content: center;
    }

    .modal.show { display: flex; }

    .modal-content {
        background: linear-gradient(135deg, #1e293b 0%, #0f172a 100%);
        border: 1px solid rgba(148, 163, 184, 0.2);
        border-radius: 28px;
        width: 95%;
        max-width: 1100px;
        max-height: 95vh;
        overflow-y: auto;
    }

    .modal-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 1.5rem 2.5rem;
        border-bottom: 1px solid rgba(148, 163, 184, 0.15);
    }

    .module-tabs {
        display: flex;
        gap: 0.5rem;
        padding: 1rem 2.5rem;
        background: rgba(15, 23, 42, 0.3);
        border-bottom: 1px solid rgba(148, 163, 184, 0.1);
    }

    .tab-btn {
        padding: 0.75rem 1.5rem;
        background: transparent;
        border: 2px solid transparent;
        border-radius: 10px;
        color: #94a3b8;
        font-family: 'Syne', sans-serif;
        font-weight: 600;
        cursor: pointer;
        transition: all 0.3s;
    }

    .tab-btn.active {
        background: rgba(59, 130, 246, 0.1);
        border-color: #60a5fa;
        color: #60a5fa;
    }

    .tab-content { display: none; padding: 2rem 2.5rem; }
    .tab-content.active { display: block; }

    .form-group { margin-bottom: 1.5rem; }
    .form-group label { display: block; font-family: 'Space Mono', monospace; font-size: 0.75rem; color: #94a3b8; text-transform: uppercase; margin-bottom: 0.5rem; }
    .form-group input, .form-group select, .form-group textarea {
        width: 100%; padding: 0.85rem; background: rgba(30, 41, 59, 0.6); border: 2px solid rgba(148, 163, 184, 0.2); border-radius: 10px; color: #f1f5f9;
    }

    .question-item {
        background: rgba(15, 23, 42, 0.4);
        border: 1px solid rgba(148, 163, 184, 0.1);
        border-radius: 16px;
        padding: 1.5rem;
        margin-bottom: 1.5rem;
    }

    .options-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 1rem; margin-top: 1rem; }
    .option-item { display: flex; align-items: center; gap: 0.5rem; }
    .option-input { flex: 1; padding: 0.6rem; background: rgba(30, 41, 59, 0.4); border: 1px solid rgba(148, 163, 184, 0.2); border-radius: 8px; color: #fff; }

    .form-actions {
        padding: 1.5rem 2.5rem;
        display: flex;
        justify-content: flex-end;
        gap: 1rem;
        border-top: 1px solid rgba(148, 163, 184, 0.15);
        background: rgba(15, 23, 42, 0.4);
    }

    .btn-primary { padding: 0.75rem 2rem; background: linear-gradient(135deg, #3b82f6, #8b5cf6); border: none; border-radius: 10px; color: #fff; font-weight: 700; cursor: pointer; }
    .btn-secondary { padding: 0.75rem 2rem; background: rgba(100, 116, 139, 0.2); border: 1px solid rgba(148, 163, 184, 0.3); border-radius: 10px; color: #94a3b8; cursor: pointer; }

    .add-question-btn {
        width: 100%; padding: 1rem; background: rgba(59, 130, 246, 0.1); border: 2px dashed rgba(96, 165, 250, 0.3); border-radius: 12px; color: #60a5fa; cursor: pointer; margin-top: 1rem;
    }
</style>

<div class="tests-wrapper">
    <div class="tests-header">
        <div>
            <h1 class="tests-title">Test Management</h1>
            <p style="font-family: 'Space Mono', monospace; color: #94a3b8; letter-spacing: 1px; text-transform: uppercase;">Manage Full SAT Test Sets</p>
        </div>
        <button class="add-test-btn" onclick="openFullTestModal()">
            <i class="fas fa-plus"></i> Add Full Test Set
        </button>
    </div>

    <div class="tests-grid" id="tests-grid">
        <div style="text-align: center; padding: 4rem; color: #94a3b8;">Loading tests...</div>
    </div>
</div>

<!-- Full Test Set Modal -->
<div id="full-test-modal" class="modal">
    <div class="modal-content">
        <div class="modal-header">
            <h3 class="modal-title" id="modal-title-main">Add Full Test Set</h3>
            <button class="btn-secondary" style="padding: 0.5rem; width: 40px; height: 40px; border-radius: 50%; display: flex; align-items: center; justify-content: center;" onclick="closeModal()">
                <i class="fas fa-times"></i>
            </button>
        </div>

        <div style="padding: 1.5rem 2.5rem 0;">
            <div class="form-group">
                <label>Test Set Title (e.g., Practice Test 1)</label>
                <input type="text" id="set-title" placeholder="Practice Test 1" required style="font-size: 1.2rem; font-weight: 700;">
            </div>
            <div class="form-group">
                <label>Description (Optional)</label>
                <textarea id="set-description" rows="2" placeholder="Description of this test set..."></textarea>
            </div>
        </div>

        <div class="module-tabs">
            <button class="tab-btn active" onclick="switchTab('english_module1')">English 1</button>
            <button class="tab-btn" onclick="switchTab('english_module2')">English 2</button>
            <button class="tab-btn" onclick="switchTab('math_module1')">Math 1</button>
            <button class="tab-btn" onclick="switchTab('math_module2')">Math 2</button>
        </div>

        <!-- Module Contents -->
        <div id="english_module1_content" class="tab-content active">
            <div class="form-group">
                <label>Duration (min)</label>
                <input type="number" class="module-duration" value="32" data-module="english_module1">
            </div>
            <div class="questions-container" id="english_module1_questions"></div>
            <button class="add-question-btn" onclick="addQuestion('english_module1')"><i class="fas fa-plus"></i> Add Question to English 1</button>
        </div>

        <div id="english_module2_content" class="tab-content">
            <div class="form-group">
                <label>Duration (min)</label>
                <input type="number" class="module-duration" value="32" data-module="english_module2">
            </div>
            <div class="questions-container" id="english_module2_questions"></div>
            <button class="add-question-btn" onclick="addQuestion('english_module2')"><i class="fas fa-plus"></i> Add Question to English 2</button>
        </div>

        <div id="math_module1_content" class="tab-content">
            <div class="form-group">
                <label>Duration (min)</label>
                <input type="number" class="module-duration" value="35" data-module="math_module1">
            </div>
            <div class="questions-container" id="math_module1_questions"></div>
            <button class="add-question-btn" onclick="addQuestion('math_module1')"><i class="fas fa-plus"></i> Add Question to Math 1</button>
        </div>

        <div id="math_module2_content" class="tab-content">
            <div class="form-group">
                <label>Duration (min)</label>
                <input type="number" class="module-duration" value="35" data-module="math_module2">
            </div>
            <div class="questions-container" id="math_module2_questions"></div>
            <button class="add-question-btn" onclick="addQuestion('math_module2')"><i class="fas fa-plus"></i> Add Question to Math 2</button>
        </div>

        <div class="form-actions">
            <button class="btn-secondary" onclick="closeModal()">Cancel</button>
            <button class="btn-primary" onclick="saveFullTestSet()" id="save-btn">Save Full Test Set</button>
        </div>
    </div>
</div>

{% endblock %}

{% block extra_js %}
<script>
let moduleQuestions = {
    english_module1: [],
    english_module2: [],
    math_module1: [],
    math_module2: []
};

document.addEventListener('DOMContentLoaded', loadTests);

function closeModal() {
    document.getElementById('full-test-modal').classList.remove('show');
}

function openFullTestModal() {
    document.getElementById('modal-title-main').textContent = 'Add Full Test Set';
    document.getElementById('set-title').value = '';
    document.getElementById('set-description').value = '';
    
    moduleQuestions = {
        english_module1: [],
        english_module2: [],
        math_module1: [],
        math_module2: []
    };
    
    ['english_module1', 'english_module2', 'math_module1', 'math_module2'].forEach(m => {
        document.getElementById(`${m}_questions`).innerHTML = '';
        // Pre-populate with one question if needed or just leave empty
    });
    
    switchTab('english_module1');
    document.getElementById('full-test-modal').classList.add('show');
}

function switchTab(moduleType) {
    document.querySelectorAll('.tab-btn').forEach(btn => {
        btn.classList.toggle('active', btn.textContent.toLowerCase().replace(' ', '') === moduleType.replace('_', ''));
    });
    // Fix: textContent mapping is a bit loose, let's use exact match or index
    const buttons = document.querySelectorAll('.tab-btn');
    buttons[0].classList.toggle('active', moduleType === 'english_module1');
    buttons[1].classList.toggle('active', moduleType === 'english_module2');
    buttons[2].classList.toggle('active', moduleType === 'math_module1');
    buttons[3].classList.toggle('active', moduleType === 'math_module2');

    document.querySelectorAll('.tab-content').forEach(content => {
        content.classList.toggle('active', content.id === `${moduleType}_content`);
    });
}

function addQuestion(moduleType, data = null) {
    const container = document.getElementById(`${moduleType}_questions`);
    const qIndex = container.children.length + 1;
    
    const div = document.createElement('div');
    div.className = 'question-item';
    div.innerHTML = `
        <div style="display: flex; justify-content: space-between; margin-bottom: 1rem;">
            <span style="font-weight: 700; color: #60a5fa;">Q${qIndex}</span>
            <button onclick="this.parentElement.parentElement.remove()" style="color: #f87171; background: none; border: none; cursor: pointer;"><i class="fas fa-trash"></i></button>
        </div>
        <textarea class="q-text" rows="2" placeholder="Question text..." required>${data ? (data.text || data.question_text || '') : ''}</textarea>
        <div class="options-grid">
            ${['A', 'B', 'C', 'D'].map(label => {
                const optText = data ? (data.options ? data.options.find(o => o.label === label)?.text : data[`option_${label.toLowerCase()}`]) : '';
                const isCorrect = data ? data.correct_answer === label : label === 'A';
                return `
                    <div class="option-item">
                        <input type="radio" name="correct_${moduleType}_${qIndex}" value="${label}" ${isCorrect ? 'checked' : ''}>
                        <span>${label})</span>
                        <input type="text" class="opt-text" placeholder="Option ${label}" value="${optText || ''}" required>
                    </div>
                `;
            }).join('')}
        </div>
    `;
    container.appendChild(div);
}

async function saveFullTestSet() {
    const title = document.getElementById('set-title').value.trim();
    if (!title) { alert('Title is required'); return; }
    
    const saveBtn = document.getElementById('save-btn');
    saveBtn.disabled = true;
    saveBtn.textContent = 'Saving...';

    const modulesData = {};
    const moduleTypes = ['english_module1', 'english_module2', 'math_module1', 'math_module2'];
    
    moduleTypes.forEach(m => {
        const container = document.getElementById(`${m}_questions`);
        const duration = document.querySelector(`.module-duration[data-module="${m}"]`).value;
        const questions = [];
        
        Array.from(container.children).forEach((qItem, idx) => {
            const text = qItem.querySelector('.q-text').value;
            const options = [];
            let correct = 'A';
            
            qItem.querySelectorAll('.option-item').forEach(opt => {
                const label = opt.querySelector('span').textContent.replace(')', '');
                const optText = opt.querySelector('.opt-text').value;
                options.push({ label, text: optText });
                if (opt.querySelector('input').checked) correct = label;
            });
            
            questions.push({ text, options, correct_answer: correct, order: idx + 1 });
        });
        
        modulesData[m] = { duration: parseInt(duration), questions };
    });

    try {
        const response = await fetch('/api/tests/set-create/', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
                title,
                description: document.getElementById('set-description').value,
                modules: modulesData
            })
        });
        
        const result = await response.json();
        if (result.success) {
            alert('Full test set saved successfully!');
            closeModal();
            loadTests();
        } else {
            alert('Error: ' + result.message);
        }
    } catch (e) {
        console.error(e);
        alert('An error occurred while saving.');
    } finally {
        saveBtn.disabled = false;
        saveBtn.textContent = 'Save Full Test Set';
    }
}

async function loadTests() {
    const grid = document.getElementById('tests-grid');
    try {
        const response = await fetch('/api/tests/');
        const result = await response.json();
        
        const groups = {};
        result.data.forEach(t => {
            const key = t.title.toLowerCase().trim();
            if (!groups[key]) groups[key] = { title: t.title, modules: {} };
            groups[key].modules[t.test_type] = t;
        });

        const keys = Object.keys(groups);
        if (keys.length === 0) {
            grid.innerHTML = '<div style="text-align: center; padding: 4rem; color: #94a3b8;">No test sets found.</div>';
            return;
        }

        grid.innerHTML = keys.map(key => {
            const group = groups[key];
            const m = group.modules;
            const isComplete = m.english_module1 && m.english_module2 && m.math_module1 && m.math_module2;
            
            return `
                <div class="test-set-card">
                    <div class="test-set-header">
                        <div>
                            <h3 class="test-set-title">${group.title}</h3>
                            <div style="margin-top: 0.5rem;">
                                <span class="status-badge ${m.english_module1 ? 'complete' : 'incomplete'}">Eng 1</span>
                                <span class="status-badge ${m.english_module2 ? 'complete' : 'incomplete'}">Eng 2</span>
                                <span class="status-badge ${m.math_module1 ? 'complete' : 'incomplete'}">Math 1</span>
                                <span class="status-badge ${m.math_module2 ? 'complete' : 'incomplete'}">Math 2</span>
                            </div>
                        </div>
                        <div style="display: flex; gap: 1rem;">
                            <button class="btn-primary" onclick="editFullTestSet('${group.title.replace(/'/g, "\\'")}')">
                                <i class="fas fa-edit"></i> Edit Set
                            </button>
                            <button class="btn-secondary" style="color: #f87171; border-color: rgba(248, 113, 113, 0.3);" onclick="deleteFullSet('${group.title.replace(/'/g, "\\'")}')">
                                <i class="fas fa-trash"></i>
                            </button>
                        </div>
                    </div>
                    <div class="sections-container">
                        <div class="section-column">
                            <h4 class="section-title"><i class="fas fa-book-open"></i> English</h4>
                            ${m.english_module1 ? `<div class="module-item"><span>Module 1</span> <span>${m.english_module1.questions_count} Qs</span></div>` : ''}
                            ${m.english_module2 ? `<div class="module-item"><span>Module 2</span> <span>${m.english_module2.questions_count} Qs</span></div>` : ''}
                        </div>
                        <div class="section-column">
                            <h4 class="section-title"><i class="fas fa-calculator"></i> Math</h4>
                            ${m.math_module1 ? `<div class="module-item"><span>Module 1</span> <span>${m.math_module1.questions_count} Qs</span></div>` : ''}
                            ${m.math_module2 ? `<div class="module-item"><span>Module 2</span> <span>${m.math_module2.questions_count} Qs</span></div>` : ''}
                        </div>
                    </div>
                    <div style="text-align: center; margin-top: 1.5rem; color: ${isComplete ? '#34d399' : '#f87171'}; font-weight: 700;">
                        ${isComplete ? '<i class="fas fa-check-circle"></i> Complete Set' : '<i class="fas fa-exclamation-triangle"></i> Incomplete Set'}
                    </div>
                </div>
            `;
        }).join('');
    } catch (e) {
        grid.innerHTML = '<div style="text-align: center; padding: 4rem; color: #f87171;">Error loading tests.</div>';
    }
}

async function editFullTestSet(title) {
    openFullTestModal();
    document.getElementById('modal-title-main').textContent = 'Edit Full Test Set: ' + title;
    document.getElementById('set-title').value = title;
    
    try {
        const response = await fetch('/api/tests/');
        const result = await response.json();
        const related = result.data.filter(t => t.title.toLowerCase().trim() === title.toLowerCase().trim());
        
        related.forEach(t => {
            const m = t.test_type;
            document.querySelector(`.module-duration[data-module="${m}"]`).value = t.duration;
            const container = document.getElementById(`${m}_questions`);
            container.innerHTML = '';
            if (t.questions) {
                t.questions.forEach(q => addQuestion(m, q));
            }
        });
    } catch (e) { console.error(e); }
}

async function deleteFullSet(title) {
    if (!confirm('Are you sure you want to delete this ENTIRE test set (all 4 modules)?')) return;
    try {
        const response = await fetch('/api/tests/');
        const result = await response.json();
        const related = result.data.filter(t => t.title.toLowerCase().trim() === title.toLowerCase().trim());
        for (const t of related) {
            await fetch(`/api/tests/${t.id}/delete/`, { method: 'DELETE' });
        }
        loadTests();
    } catch (e) { console.error(e); }
}
</script>
{% endblock %}
