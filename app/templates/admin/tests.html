{% extends 'admin/base.html' %}

{% block title %}Test Management{% endblock %}

{% block content %}
<style>
    @import url('https://fonts.googleapis.com/css2?family=Space+Mono:wght@400;700&family=Syne:wght@400..800&family=Karla:wght@300;400;500;600;700&display=swap');

    .tests-wrapper {
        font-family: 'Karla', sans-serif;
        background: linear-gradient(135deg, #0f172a 0%, #1e293b 50%, #334155 100%);
        min-height: 100vh;
        margin: -32px;
        padding: 2rem;
        position: relative;
        overflow: hidden;
    }

    .tests-wrapper::before {
        content: '';
        position: absolute;
        top: -50%;
        right: -20%;
        width: 600px;
        height: 600px;
        background: radial-gradient(circle, rgba(59, 130, 246, 0.15) 0%, transparent 70%);
        animation: float 20s ease-in-out infinite;
        pointer-events: none;
    }

    .tests-wrapper::after {
        content: '';
        position: absolute;
        bottom: -30%;
        left: -10%;
        width: 500px;
        height: 500px;
        background: radial-gradient(circle, rgba(168, 85, 247, 0.1) 0%, transparent 70%);
        animation: float 25s ease-in-out infinite reverse;
        pointer-events: none;
    }

    @keyframes float {
        0%, 100% { transform: translate(0, 0) scale(1); }
        50% { transform: translate(30px, -30px) scale(1.1); }
    }

    .tests-header {
        position: relative;
        z-index: 2;
        margin-bottom: 3rem;
        display: flex;
        justify-content: space-between;
        align-items: center;
        animation: slideDown 0.8s ease-out;
    }

    @keyframes slideDown {
        from { opacity: 0; transform: translateY(-30px); }
        to { opacity: 1; transform: translateY(0); }
    }

    .tests-title {
        font-family: 'Syne', sans-serif;
        font-size: 3.5rem;
        font-weight: 800;
        background: linear-gradient(135deg, #60a5fa 0%, #a78bfa 50%, #ec4899 100%);
        -webkit-background-clip: text;
        -webkit-text-fill-color: transparent;
        background-clip: text;
        letter-spacing: -2px;
        margin-bottom: 0.5rem;
    }

    .tests-subtitle {
        font-family: 'Space Mono', monospace;
        font-size: 0.95rem;
        color: #94a3b8;
        letter-spacing: 1px;
        text-transform: uppercase;
    }

    .add-test-btn {
        padding: 1rem 2rem;
        background: linear-gradient(135deg, #3b82f6, #8b5cf6);
        border: none;
        border-radius: 12px;
        font-family: 'Syne', sans-serif;
        font-size: 0.95rem;
        font-weight: 600;
        color: #fff;
        cursor: pointer;
        transition: all 0.3s ease;
        display: flex;
        align-items: center;
        gap: 0.5rem;
    }

    .add-test-btn:hover {
        transform: translateY(-2px);
        box-shadow: 0 12px 40px rgba(59, 130, 246, 0.4);
    }

    .category-tabs {
        display: flex;
        gap: 1rem;
        margin-bottom: 2rem;
        position: relative;
        z-index: 2;
    }

    .tab-btn {
        padding: 0.75rem 1.75rem;
        background: rgba(15, 23, 42, 0.6);
        backdrop-filter: blur(20px);
        border: 2px solid rgba(148, 163, 184, 0.2);
        border-radius: 12px;
        font-family: 'Space Mono', monospace;
        font-size: 0.85rem;
        font-weight: 600;
        color: #94a3b8;
        cursor: pointer;
        transition: all 0.3s ease;
        text-transform: uppercase;
        letter-spacing: 1px;
    }

    .tab-btn:hover {
        border-color: #60a5fa;
        color: #60a5fa;
    }

    .tab-btn.active {
        background: linear-gradient(135deg, #3b82f6, #8b5cf6);
        border-color: transparent;
        color: #fff;
    }

    .tests-grid {
        display: grid;
        grid-template-columns: 1fr;
        gap: 2.5rem;
        position: relative;
        z-index: 2;
    }

    .test-set-card {
        background: rgba(15, 23, 42, 0.6);
        backdrop-filter: blur(20px);
        border: 1px solid rgba(148, 163, 184, 0.2);
        border-radius: 32px;
        padding: 2.5rem;
        transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
        position: relative;
    }

    .test-set-header {
        display: flex;
        justify-content: space-between;
        align-items: flex-start;
        margin-bottom: 2rem;
        padding-bottom: 1.5rem;
        border-bottom: 1px solid rgba(148, 163, 184, 0.1);
    }

    .test-set-title {
        font-family: 'Syne', sans-serif;
        font-size: 2rem;
        font-weight: 800;
        color: #f1f5f9;
        margin: 0;
    }

    .test-set-status {
        display: flex;
        gap: 1rem;
    }

    .status-badge {
        padding: 0.5rem 1rem;
        border-radius: 12px;
        font-family: 'Space Mono', monospace;
        font-size: 0.75rem;
        font-weight: 700;
        display: flex;
        align-items: center;
        gap: 0.5rem;
    }

    .status-badge.complete {
        background: rgba(16, 185, 129, 0.1);
        color: #34d399;
        border: 1px solid rgba(52, 211, 153, 0.3);
    }

    .status-badge.incomplete {
        background: rgba(239, 68, 68, 0.1);
        color: #f87171;
        border: 1px solid rgba(248, 113, 113, 0.3);
    }

    .sections-container {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 2rem;
    }

    .section-column {
        background: rgba(30, 41, 59, 0.3);
        border-radius: 24px;
        padding: 1.5rem;
        border: 1px solid rgba(148, 163, 184, 0.1);
    }

    .section-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 1.5rem;
    }

    .section-title {
        font-family: 'Syne', sans-serif;
        font-size: 1.25rem;
        font-weight: 700;
        color: #cbd5e1;
        display: flex;
        align-items: center;
        gap: 0.75rem;
    }

    .section-title i {
        color: #60a5fa;
    }

    .add-section-btn {
        padding: 0.6rem 1.2rem;
        background: rgba(59, 130, 246, 0.15);
        border: 1px solid rgba(96, 165, 250, 0.3);
        border-radius: 10px;
        color: #60a5fa;
        font-weight: 600;
        font-size: 0.85rem;
        cursor: pointer;
        transition: all 0.3s;
    }

    .add-section-btn:hover {
        background: #3b82f6;
        color: white;
    }

    .questions-list {
        display: flex;
        flex-direction: column;
        gap: 0.75rem;
        max-height: 300px;
        overflow-y: auto;
        padding-right: 0.5rem;
    }

    .question-row {
        background: rgba(15, 23, 42, 0.4);
        border: 1px solid rgba(148, 163, 184, 0.1);
        border-radius: 12px;
        padding: 1rem;
        display: flex;
        justify-content: space-between;
        align-items: center;
        transition: all 0.2s;
    }

    .question-row:hover {
        border-color: rgba(96, 165, 250, 0.3);
        background: rgba(15, 23, 42, 0.6);
    }

    .question-info {
        display: flex;
        flex-direction: column;
        gap: 0.25rem;
    }

    .question-label {
        font-family: 'Space Mono', monospace;
        font-size: 0.75rem;
        color: #60a5fa;
    }

    .question-preview {
        font-size: 0.9rem;
        color: #94a3b8;
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
        max-width: 200px;
    }

    .question-actions {
        display: flex;
        gap: 0.5rem;
    }

    .q-action-btn {
        width: 32px;
        height: 32px;
        border-radius: 8px;
        display: flex;
        align-items: center;
        justify-content: center;
        border: none;
        cursor: pointer;
        transition: all 0.2s;
        font-size: 0.85rem;
    }

    .q-action-btn.edit {
        background: rgba(59, 130, 246, 0.1);
        color: #60a5fa;
    }

    .q-action-btn.delete {
        background: rgba(239, 68, 68, 0.1);
        color: #f87171;
    }

    .q-action-btn:hover {
        transform: scale(1.1);
    }

    .q-action-btn.edit:hover { background: #3b82f6; color: white; }
    .q-action-btn.delete:hover { background: #ef4444; color: white; }

    .test-actions-main {
        display: flex;
        gap: 1rem;
    }

    @media (max-width: 1024px) {
        .sections-container {
            grid-template-columns: 1fr;
        }
    }

    .loading-state, .no-data {
        grid-column: 1 / -1;
        text-align: center;
        padding: 4rem 2rem;
        color: #64748b;
        font-family: 'Syne', sans-serif;
        font-size: 1.2rem;
    }

    .modal {
        display: none;
        position: fixed;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: rgba(0, 0, 0, 0.7);
        backdrop-filter: blur(10px);
        z-index: 1000;
        align-items: center;
        justify-content: center;
    }

    .modal.show {
        display: flex;
    }

    .modal-content {
        background: linear-gradient(135deg, #1e293b 0%, #0f172a 100%);
        border: 1px solid rgba(148, 163, 184, 0.2);
        border-radius: 28px;
        width: 90%;
        max-width: 900px;
        max-height: 90vh;
        overflow-y: auto;
    }

    .modal-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 2rem 2.5rem;
        border-bottom: 1px solid rgba(148, 163, 184, 0.15);
    }

    .modal-title {
        font-family: 'Syne', sans-serif;
        font-size: 1.8rem;
        font-weight: 700;
        color: #f1f5f9;
    }

    .close-modal {
        width: 40px;
        height: 40px;
        border-radius: 12px;
        background: rgba(100, 116, 139, 0.2);
        border: none;
        color: #94a3b8;
        font-size: 1.5rem;
        cursor: pointer;
        transition: all 0.3s ease;
    }

    .close-modal:hover {
        background: rgba(239, 68, 68, 0.2);
        color: #f87171;
    }

    .subject-selector, .module-selector {
        display: grid;
        grid-template-columns: repeat(2, 1fr);
        gap: 1.5rem;
        padding: 2.5rem;
    }

    .subject-card, .module-card {
        background: rgba(30, 41, 59, 0.4);
        border: 2px solid rgba(148, 163, 184, 0.2);
        border-radius: 20px;
        padding: 2rem;
        text-align: center;
        cursor: pointer;
        transition: all 0.3s ease;
    }

    .subject-card:hover, .module-card:hover {
        border-color: #60a5fa;
        background: rgba(59, 130, 246, 0.1);
        transform: translateY(-4px);
    }

    .subject-icon, .module-icon {
        width: 70px;
        height: 70px;
        border-radius: 16px;
        display: flex;
        align-items: center;
        justify-content: center;
        margin: 0 auto 1.5rem;
        color: white;
        font-size: 1.8rem;
    }

    .subject-card h4, .module-card h4 {
        font-family: 'Syne', sans-serif;
        font-size: 1.3rem;
        font-weight: 700;
        color: #f1f5f9;
        margin-bottom: 0.5rem;
    }

    .subject-card p, .module-card p {
        font-size: 0.9rem;
        color: #94a3b8;
        margin-bottom: 1rem;
    }

    .badge-info {
        display: inline-block;
        background: rgba(59, 130, 246, 0.15);
        color: #60a5fa;
        padding: 0.5rem 1rem;
        border-radius: 10px;
        font-family: 'Space Mono', monospace;
        font-size: 0.75rem;
        font-weight: 700;
        border: 1px solid rgba(96, 165, 250, 0.3);
    }

    #test-form {
        padding: 2.5rem;
    }

    .form-group {
        margin-bottom: 1.5rem;
    }

    .form-group label {
        display: block;
        font-family: 'Space Mono', monospace;
        font-size: 0.8rem;
        color: #94a3b8;
        text-transform: uppercase;
        letter-spacing: 1px;
        margin-bottom: 0.75rem;
    }

    .form-group input,
    .form-group select,
    .form-group textarea {
        width: 100%;
        padding: 1rem;
        background: rgba(30, 41, 59, 0.6);
        border: 2px solid rgba(148, 163, 184, 0.2);
        border-radius: 12px;
        font-family: 'Karla', sans-serif;
        font-size: 0.95rem;
        color: #f1f5f9;
        transition: all 0.3s ease;
    }

    .form-group input:focus,
    .form-group select:focus,
    .form-group textarea:focus {
        outline: none;
        border-color: #60a5fa;
        background: rgba(30, 41, 59, 0.8);
        box-shadow: 0 0 0 4px rgba(96, 165, 250, 0.1);
    }

    .form-row {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 1.5rem;
    }

    .questions-section {
        background: rgba(30, 41, 59, 0.4);
        border-radius: 16px;
        padding: 2rem;
        margin: 2rem 0;
        border: 1px solid rgba(148, 163, 184, 0.15);
    }

    .questions-header h4 {
        font-family: 'Syne', sans-serif;
        font-size: 1.2rem;
        color: #f1f5f9;
        display: flex;
        align-items: center;
        gap: 0.75rem;
        margin-bottom: 1.5rem;
    }

    #question-count-badge {
        font-family: 'Space Mono', monospace;
        font-weight: 400;
        color: #94a3b8;
    }

    #questions-container {
        display: flex;
        flex-direction: column;
        gap: 1.5rem;
        max-height: 400px;
        overflow-y: auto;
        padding-right: 0.5rem;
    }

    .question-item {
        background: rgba(15, 23, 42, 0.6);
        border: 1px solid rgba(148, 163, 184, 0.2);
        border-radius: 16px;
        padding: 1.5rem;
    }

    .question-item-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 1rem;
    }

    .question-number {
        font-family: 'Syne', sans-serif;
        font-weight: 700;
        color: #60a5fa;
        font-size: 1rem;
    }

    .delete-question-btn {
        background: rgba(239, 68, 68, 0.15);
        border: 1px solid rgba(248, 113, 113, 0.3);
        color: #f87171;
        padding: 0.5rem;
        border-radius: 8px;
        cursor: pointer;
        transition: all 0.3s ease;
    }

    .delete-question-btn:hover {
        background: rgba(239, 68, 68, 0.3);
    }

    .question-text-input {
        width: 100%;
        padding: 1rem;
        background: rgba(30, 41, 59, 0.6);
        border: 2px solid rgba(148, 163, 184, 0.2);
        border-radius: 12px;
        font-family: 'Karla', sans-serif;
        font-size: 0.95rem;
        color: #f1f5f9;
        margin-bottom: 1rem;
        resize: vertical;
    }

    .question-text-input:focus {
        outline: none;
        border-color: #60a5fa;
        box-shadow: 0 0 0 4px rgba(96, 165, 250, 0.1);
    }

    .image-upload-section {
        margin-bottom: 1rem;
        padding: 1rem;
        background: rgba(30, 41, 59, 0.4);
        border-radius: 12px;
        border: 2px dashed rgba(148, 163, 184, 0.3);
    }

    .image-upload-section.has-image {
        border-style: solid;
        border-color: #34d399;
    }

    .image-upload-label {
        display: flex;
        align-items: center;
        gap: 0.75rem;
        cursor: pointer;
        color: #94a3b8;
        font-size: 0.9rem;
    }

    .image-upload-label i {
        color: #60a5fa;
    }

    .image-upload-input {
        display: none;
    }

    .image-preview {
        margin-top: 1rem;
        position: relative;
    }

    .image-preview img {
        max-width: 200px;
        max-height: 150px;
        border-radius: 12px;
    }

    .remove-image-btn {
        position: absolute;
        top: -8px;
        right: -8px;
        background: #ef4444;
        color: white;
        border: none;
        border-radius: 50%;
        width: 28px;
        height: 28px;
        cursor: pointer;
        font-size: 0.85rem;
    }

    .options-grid {
        display: grid;
        grid-template-columns: repeat(2, 1fr);
        gap: 0.75rem;
    }

    .option-item {
        display: flex;
        align-items: center;
        gap: 0.75rem;
    }

    .option-radio {
        width: 20px;
        height: 20px;
        accent-color: #34d399;
    }

    .option-label {
        font-family: 'Syne', sans-serif;
        font-weight: 700;
        color: #cbd5e1;
        min-width: 30px;
    }

    .option-input {
        flex: 1;
        padding: 0.75rem;
        background: rgba(30, 41, 59, 0.6);
        border: 2px solid rgba(148, 163, 184, 0.2);
        border-radius: 8px;
        font-family: 'Karla', sans-serif;
        font-size: 0.9rem;
        color: #f1f5f9;
    }

    .option-input:focus {
        outline: none;
        border-color: #60a5fa;
    }

    .add-question-btn {
        width: 100%;
        margin-top: 1rem;
        padding: 1rem;
        background: rgba(59, 130, 246, 0.15);
        border: 2px dashed rgba(96, 165, 250, 0.3);
        border-radius: 12px;
        font-family: 'Syne', sans-serif;
        font-size: 0.95rem;
        font-weight: 600;
        color: #60a5fa;
        cursor: pointer;
        transition: all 0.3s ease;
    }

    .add-question-btn:hover {
        background: rgba(59, 130, 246, 0.25);
        border-color: #60a5fa;
    }

    .form-actions {
        display: flex;
        justify-content: flex-end;
        gap: 1rem;
        padding-top: 2rem;
        border-top: 1px solid rgba(148, 163, 184, 0.15);
    }

    .form-actions button {
        padding: 1rem 2rem;
        border-radius: 12px;
        font-family: 'Syne', sans-serif;
        font-size: 0.95rem;
        font-weight: 600;
        cursor: pointer;
        transition: all 0.3s ease;
    }

    .form-actions .btn-secondary {
        background: rgba(100, 116, 139, 0.2);
        border: 1px solid rgba(148, 163, 184, 0.3);
        color: #94a3b8;
    }

    .form-actions .btn-secondary:hover {
        background: rgba(100, 116, 139, 0.3);
    }

    .form-actions .btn-primary {
        background: linear-gradient(135deg, #3b82f6, #8b5cf6);
        border: none;
        color: #fff;
    }

    .form-actions .btn-primary:hover {
        transform: translateY(-2px);
        box-shadow: 0 12px 40px rgba(59, 130, 246, 0.4);
    }
</style>

<div class="tests-wrapper">
    <div class="tests-header">
        <div>
            <h1 class="tests-title">Test Management</h1>
            <p class="tests-subtitle">Create & Manage SAT Tests</p>
        </div>
        <button class="add-test-btn" onclick="openSubjectSelector()">
            <i class="fas fa-plus"></i> Add New Test
        </button>
    </div>

    <div class="category-tabs">
        <button class="tab-btn active" data-category="all">All Tests</button>
        <button class="tab-btn" data-category="english">English</button>
        <button class="tab-btn" data-category="math">Math</button>
    </div>

    <div class="tests-grid" id="tests-grid">
        <div class="loading-state">Loading tests...</div>
    </div>
</div>

<div id="subject-selector-modal" class="modal">
    <div class="modal-content" style="max-width: 600px;">
        <div class="modal-header">
            <h3 class="modal-title">Select Subject</h3>
            <button class="close-modal">&times;</button>
        </div>
        <div class="subject-selector">
            <div class="subject-card" onclick="selectSubject('english')">
                <div class="subject-icon" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);">
                    <i class="fas fa-book-open"></i>
                </div>
                <h4>English</h4>
                <p>Reading & Writing modules</p>
                <span class="badge-info">2 Modules • 54 Questions</span>
            </div>
            <div class="subject-card" onclick="selectSubject('math')">
                <div class="subject-icon" style="background: linear-gradient(135deg, #11998e 0%, #38ef7d 100%);">
                    <i class="fas fa-calculator"></i>
                </div>
                <h4>Math</h4>
                <p>Module 1 & Module 2</p>
                <span class="badge-info">2 Modules • 44 Questions</span>
            </div>
        </div>
    </div>
</div>

<div id="module-selector-modal" class="modal">
    <div class="modal-content" style="max-width: 600px;">
        <div class="modal-header">
            <h3 id="module-selector-title" class="modal-title">Select Module</h3>
            <button class="close-modal">&times;</button>
        </div>
        <div class="module-selector" id="module-selector-content">
        </div>
    </div>
</div>

<div id="test-modal" class="modal">
    <div class="modal-content">
        <div class="modal-header">
            <h3 id="modal-title" class="modal-title">Add New Test</h3>
            <button class="close-modal">&times;</button>
        </div>
        <form id="test-form">
            <input type="hidden" id="test-id">
            <input type="hidden" id="test-category">
            <input type="hidden" id="test-module">
            
            <div class="form-row">
                <div class="form-group">
                    <label>Test Title (Test Set Name)</label>
                    <input type="text" id="test-title" required placeholder="e.g., Practice Test 1" list="existing-titles">
                    <datalist id="existing-titles"></datalist>
                    <small style="color: #94a3b8; font-size: 0.75rem; margin-top: 0.25rem; display: block;">
                        Barcha 4ta modul (Eng 1, 2, Math 1, 2) bir xil nom ostida bo'lishi kerak.
                    </small>
                </div>
                <div class="form-group">
                    <label>Duration (minutes)</label>
                    <input type="number" id="test-duration" min="1" required value="32">
                </div>
            </div>
            
            <div class="form-group">
                <label>Description</label>
                <textarea id="test-description" rows="2" placeholder="Test description..."></textarea>
            </div>
            
            <div class="form-row">
                <div class="form-group">
                    <label>Difficulty</label>
                    <select id="test-difficulty">
                        <option value="easy">Easy</option>
                        <option value="medium" selected>Medium</option>
                        <option value="hard">Hard</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>Status</label>
                    <select id="test-active">
                        <option value="true">Active</option>
                        <option value="false">Inactive</option>
                    </select>
                </div>
            </div>

            <div class="questions-section">
                <div class="questions-header">
                    <h4><i class="fas fa-list-ol"></i> Questions <span id="question-count-badge">(0/<span id="max-questions">27</span>)</span></h4>
                </div>
                <div id="questions-container">
                </div>
                <button type="button" class="add-question-btn" onclick="addQuestion()">
                    <i class="fas fa-plus"></i> Add Question
                </button>
            </div>

            <div class="form-actions">
                <button type="button" class="btn-secondary close-modal">Cancel</button>
                <button type="submit" class="btn-primary">Save Test</button>
            </div>
        </form>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
let currentCategory = 'all';
let selectedSubject = '';
let selectedModule = '';
let questionCount = 0;
let maxQuestions = 27;

document.addEventListener('DOMContentLoaded', function() {
    loadTests();
    
    document.querySelectorAll('.tab-btn').forEach(btn => {
        btn.addEventListener('click', function() {
            document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
            this.classList.add('active');
            currentCategory = this.dataset.category;
            loadTests();
        });
    });
    
    document.querySelectorAll('.close-modal').forEach(btn => {
        btn.addEventListener('click', closeAllModals);
    });
    
    document.getElementById('test-form').addEventListener('submit', saveTest);
});

function closeAllModals() {
    document.querySelectorAll('.modal').forEach(m => m.classList.remove('show'));
}

function openSubjectSelector() {
    closeAllModals();
    document.getElementById('subject-selector-modal').classList.add('show');
}

function selectSubject(subject) {
    selectedSubject = subject;
    closeAllModals();
    
    const moduleContent = document.getElementById('module-selector-content');
    const title = document.getElementById('module-selector-title');
    
    if (subject === 'english') {
        title.textContent = 'Select English Module';
        moduleContent.innerHTML = `
            <div class="module-card" onclick="selectModule('english_module1')">
                <div class="module-icon" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);">
                    <i class="fas fa-book-reader"></i>
                </div>
                <h4>Module 1</h4>
                <p>Reading & Writing</p>
                <span class="badge-info">27 Questions • 32 min</span>
            </div>
            <div class="module-card" onclick="selectModule('english_module2')">
                <div class="module-icon" style="background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);">
                    <i class="fas fa-pen-fancy"></i>
                </div>
                <h4>Module 2</h4>
                <p>Reading & Writing</p>
                <span class="badge-info">27 Questions • 32 min</span>
            </div>
        `;
        maxQuestions = 27;
    } else {
        title.textContent = 'Select Math Module';
        moduleContent.innerHTML = `
            <div class="module-card" onclick="selectModule('math_module1')">
                <div class="module-icon" style="background: linear-gradient(135deg, #11998e 0%, #38ef7d 100%);">
                    <i class="fas fa-square-root-alt"></i>
                </div>
                <h4>Module 1</h4>
                <p>No Calculator Section</p>
                <span class="badge-info">22 Questions • 35 min</span>
            </div>
            <div class="module-card" onclick="selectModule('math_module2')">
                <div class="module-icon" style="background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);">
                    <i class="fas fa-calculator"></i>
                </div>
                <h4>Module 2</h4>
                <p>Calculator Section</p>
                <span class="badge-info">22 Questions • 35 min</span>
            </div>
        `;
        maxQuestions = 22;
    }
    
    document.getElementById('module-selector-modal').classList.add('show');
}

function selectModule(module) {
    selectedModule = module;
    closeAllModals();
    openTestForm();
}

function openTestForm() {
    document.getElementById('modal-title').textContent = `Add ${selectedSubject.charAt(0).toUpperCase() + selectedSubject.slice(1)} Test - ${getModuleName(selectedModule)}`;
    document.getElementById('test-form').reset();
    document.getElementById('test-id').value = '';
    document.getElementById('test-category').value = selectedSubject;
    document.getElementById('test-module').value = selectedModule;
    document.getElementById('questions-container').innerHTML = '';
    questionCount = 0;
    
    if (selectedSubject === 'math') {
        maxQuestions = 22;
        document.getElementById('test-duration').value = 35;
    } else {
        maxQuestions = 27;
        document.getElementById('test-duration').value = 32;
    }
    
    document.getElementById('max-questions').textContent = maxQuestions;
    updateQuestionCount();
    
    document.getElementById('test-modal').classList.add('show');
}

function getModuleName(module) {
    const names = {
        'english_module1': 'English Module 1',
        'english_module2': 'English Module 2',
        'math_module1': 'Math Module 1',
        'math_module2': 'Math Module 2'
    };
    return names[module] || module;
}

function addQuestion() {
    if (questionCount >= maxQuestions) {
        alert(`Maximum ${maxQuestions} questions allowed for this module`);
        return;
    }
    
    questionCount++;
    const container = document.getElementById('questions-container');
    const showImageUpload = selectedSubject === 'math';
    
    const questionHtml = `
        <div class="question-item" data-question="${questionCount}">
            <div class="question-item-header">
                <span class="question-number">Question ${questionCount}</span>
                <button type="button" class="delete-question-btn" onclick="deleteQuestion(this)">
                    <i class="fas fa-trash"></i>
                </button>
            </div>
            <textarea class="question-text-input" placeholder="Enter question text..." rows="2" required></textarea>
            ${showImageUpload ? `
            <div class="image-upload-section">
                <label class="image-upload-label">
                    <i class="fas fa-image"></i>
                    <span>Add image (optional for math symbols)</span>
                    <input type="file" class="image-upload-input" accept="image/*" onchange="handleImageUpload(this)">
                </label>
                <div class="image-preview"></div>
            </div>
            ` : ''}
            <div class="options-grid">
                <div class="option-item">
                    <input type="radio" name="correct_${questionCount}" value="A" class="option-radio" required>
                    <span class="option-label">A)</span>
                    <input type="text" class="option-input" placeholder="Option A" required>
                </div>
                <div class="option-item">
                    <input type="radio" name="correct_${questionCount}" value="B" class="option-radio">
                    <span class="option-label">B)</span>
                    <input type="text" class="option-input" placeholder="Option B" required>
                </div>
                <div class="option-item">
                    <input type="radio" name="correct_${questionCount}" value="C" class="option-radio">
                    <span class="option-label">C)</span>
                    <input type="text" class="option-input" placeholder="Option C" required>
                </div>
                <div class="option-item">
                    <input type="radio" name="correct_${questionCount}" value="D" class="option-radio">
                    <span class="option-label">D)</span>
                    <input type="text" class="option-input" placeholder="Option D" required>
                </div>
            </div>
        </div>
    `;
    
    container.insertAdjacentHTML('beforeend', questionHtml);
    updateQuestionCount();
    container.scrollTop = container.scrollHeight;
}

function deleteQuestion(btn) {
    btn.closest('.question-item').remove();
    renumberQuestions();
}

function renumberQuestions() {
    const questions = document.querySelectorAll('.question-item');
    questionCount = questions.length;
    
    questions.forEach((q, index) => {
        const num = index + 1;
        q.dataset.question = num;
        q.querySelector('.question-number').textContent = `Question ${num}`;
        
        const radios = q.querySelectorAll('.option-radio');
        radios.forEach(radio => {
            radio.name = `correct_${num}`;
        });
    });
    
    updateQuestionCount();
}

function updateQuestionCount() {
    document.getElementById('question-count-badge').innerHTML = `(${questionCount}/<span id="max-questions">${maxQuestions}</span>)`;
}

function handleImageUpload(input) {
    const file = input.files[0];
    if (file) {
        const reader = new FileReader();
        const preview = input.closest('.image-upload-section').querySelector('.image-preview');
        const section = input.closest('.image-upload-section');
        
        reader.onload = function(e) {
            preview.innerHTML = `
                <img src="${e.target.result}" alt="Question image">
                <button type="button" class="remove-image-btn" onclick="removeImage(this)">
                    <i class="fas fa-times"></i>
                </button>
            `;
            section.classList.add('has-image');
        };
        
        reader.readAsDataURL(file);
    }
}

function removeImage(btn) {
    const section = btn.closest('.image-upload-section');
    section.querySelector('.image-preview').innerHTML = '';
    section.querySelector('.image-upload-input').value = '';
    section.classList.remove('has-image');
}

async function loadTests() {
    try {
        const response = await fetch('/api/tests/');
        const result = await response.json();
        
        const grid = document.getElementById('tests-grid');
        
        if (result.data.length === 0) {
            grid.innerHTML = '<div class="no-data">No tests found. Click "Add New Test" to create one.</div>';
            return;
        }

        // Group tests by title with all 4 modules (case-insensitive)
        const groups = {};
        result.data.forEach(test => {
            const titleKey = test.title.trim().toLowerCase();
            if (!groups[titleKey]) {
                groups[titleKey] = { 
                    displayTitle: test.title.trim(),
                    english_module1: null, 
                    english_module2: null,
                    math_module1: null,
                    math_module2: null
                };
            }
            groups[titleKey][test.test_type] = test;
            // Prefer English Module 1 for display title if available
            if (test.test_type === 'english_module1') {
                groups[titleKey].displayTitle = test.title.trim();
            }
        });

        // Populate existing titles datalist
        const datalist = document.getElementById('existing-titles');
        datalist.innerHTML = Object.keys(groups).map(key => {
            return `<option value="${groups[key].displayTitle}">`;
        }).join('');

        const filteredKeys = Object.keys(groups).filter(key => {
            if (currentCategory === 'all') return true;
            const group = groups[key];
            if (currentCategory === 'english') return group.english_module1 !== null || group.english_module2 !== null;
            if (currentCategory === 'math') return group.math_module1 !== null || group.math_module2 !== null;
            return true;
        });

        if (filteredKeys.length === 0) {
            grid.innerHTML = '<div class="no-data">No tests found for this category.</div>';
            return;
        }
        
        grid.innerHTML = filteredKeys.map(key => {
            const group = groups[key];
            const title = group.displayTitle;
            const hasE1 = !!group.english_module1;
            const hasE2 = !!group.english_module2;
            const hasM1 = !!group.math_module1;
            const hasM2 = !!group.math_module2;
            const isComplete = hasE1 && hasE2 && hasM1 && hasM2;
            
            return `
                <div class="test-set-card">
                    <div class="test-set-header">
                        <div>
                            <h3 class="test-set-title">${title}</h3>
                            <div class="test-set-status">
                                <span class="status-badge ${hasE1 ? 'complete' : 'incomplete'}">
                                    <i class="fas fa-${hasE1 ? 'check-circle' : 'circle'}"></i> Eng 1
                                </span>
                                <span class="status-badge ${hasE2 ? 'complete' : 'incomplete'}">
                                    <i class="fas fa-${hasE2 ? 'check-circle' : 'circle'}"></i> Eng 2
                                </span>
                                <span class="status-badge ${hasM1 ? 'complete' : 'incomplete'}">
                                    <i class="fas fa-${hasM1 ? 'check-circle' : 'circle'}"></i> Math 1
                                </span>
                                <span class="status-badge ${hasM2 ? 'complete' : 'incomplete'}">
                                    <i class="fas fa-${hasM2 ? 'check-circle' : 'circle'}"></i> Math 2
                                </span>
                            </div>
                        </div>
                        <div class="test-actions-main">
                            <button class="q-action-btn delete" onclick="deleteTestSet('${title}')" title="Delete entire set">
                                <i class="fas fa-trash-alt"></i>
                            </button>
                        </div>
                    </div>
                    
                    <div class="sections-container">
                        <!-- English Column -->
                        <div class="section-column">
                            <div class="section-header">
                                <h4 class="section-title"><i class="fas fa-book-open"></i> English</h4>
                                <button class="add-section-btn" onclick="addSpecificTest('${title}', 'english')">Add Module</button>
                            </div>
                            <div class="questions-list">
                                ${hasE1 ? renderModuleInfo(group.english_module1, 'Module 1') : '<p style="color: #f87171; font-size: 0.8rem;">Module 1 missing</p>'}
                                ${hasE2 ? renderModuleInfo(group.english_module2, 'Module 2') : '<p style="color: #f87171; font-size: 0.8rem;">Module 2 missing</p>'}
                            </div>
                        </div>

                        <!-- Math Column -->
                        <div class="section-column">
                            <div class="section-header">
                                <h4 class="section-title"><i class="fas fa-calculator"></i> Math</h4>
                                <button class="add-section-btn" onclick="addSpecificTest('${title}', 'math')">Add Module</button>
                            </div>
                            <div class="questions-list">
                                ${hasM1 ? renderModuleInfo(group.math_module1, 'Module 1') : '<p style="color: #f87171; font-size: 0.8rem;">Module 1 missing</p>'}
                                ${hasM2 ? renderModuleInfo(group.math_module2, 'Module 2') : '<p style="color: #f87171; font-size: 0.8rem;">Module 2 missing</p>'}
                            </div>
                        </div>
                    </div>
                    
                    ${isComplete ? '<p style="color: #34d399; text-align: center; margin-top: 1rem; font-weight: 600;"><i class="fas fa-check-circle"></i> Complete - Ready for users</p>' : '<p style="color: #f87171; text-align: center; margin-top: 1rem; font-weight: 600;"><i class="fas fa-exclamation-circle"></i> Incomplete - Add missing modules</p>'}
                </div>
            `;
        }).join('');
    } catch (error) {
        console.error('Error loading tests:', error);
    }
}

function renderModuleInfo(test, moduleName) {
    const qCount = test.questions ? test.questions.length : test.questions_count || 0;
    return `
        <div class="question-row" style="cursor: pointer;" onclick="editTest(${test.id})">
            <div class="question-info">
                <span class="question-label">${moduleName}</span>
                <span class="question-preview">${qCount} questions • ${test.duration} min</span>
            </div>
            <div class="question-actions">
                <button class="q-action-btn edit"><i class="fas fa-edit"></i></button>
            </div>
        </div>
    `;
}

function addSpecificTest(title, category) {
    selectedSubject = category;
    closeAllModals();
    
    const moduleContent = document.getElementById('module-selector-content');
    const titleEl = document.getElementById('module-selector-title');
    
    if (category === 'english') {
        titleEl.textContent = 'Select English Module';
        moduleContent.innerHTML = `
            <div class="module-card" onclick="selectModuleForTitle('${title}', 'english_module1')">
                <div class="module-icon" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);">
                    <i class="fas fa-book-reader"></i>
                </div>
                <h4>Module 1</h4>
                <p>Reading & Writing</p>
                <span class="badge-info">27 Questions • 32 min</span>
            </div>
            <div class="module-card" onclick="selectModuleForTitle('${title}', 'english_module2')">
                <div class="module-icon" style="background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);">
                    <i class="fas fa-pen-fancy"></i>
                </div>
                <h4>Module 2</h4>
                <p>Reading & Writing</p>
                <span class="badge-info">27 Questions • 32 min</span>
            </div>
        `;
        maxQuestions = 27;
    } else {
        titleEl.textContent = 'Select Math Module';
        moduleContent.innerHTML = `
            <div class="module-card" onclick="selectModuleForTitle('${title}', 'math_module1')">
                <div class="module-icon" style="background: linear-gradient(135deg, #11998e 0%, #38ef7d 100%);">
                    <i class="fas fa-square-root-alt"></i>
                </div>
                <h4>Module 1</h4>
                <p>No Calculator Section</p>
                <span class="badge-info">22 Questions • 35 min</span>
            </div>
            <div class="module-card" onclick="selectModuleForTitle('${title}', 'math_module2')">
                <div class="module-icon" style="background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);">
                    <i class="fas fa-calculator"></i>
                </div>
                <h4>Module 2</h4>
                <p>Calculator Section</p>
                <span class="badge-info">22 Questions • 35 min</span>
            </div>
        `;
        maxQuestions = 22;
    }
    
    document.getElementById('module-selector-modal').classList.add('show');
}

function selectModuleForTitle(title, module) {
    selectedModule = module;
    selectedSubject = module.startsWith('english') ? 'english' : 'math';
    closeAllModals();
    
    document.getElementById('modal-title').textContent = `Add ${selectedSubject.charAt(0).toUpperCase() + selectedSubject.slice(1)} Test - ${getModuleName(module)}`;
    document.getElementById('test-form').reset();
    document.getElementById('test-id').value = '';
    document.getElementById('test-title').value = title;
    document.getElementById('test-category').value = selectedSubject;
    document.getElementById('test-module').value = module;
    document.getElementById('questions-container').innerHTML = '';
    questionCount = 0;
    
    if (selectedSubject === 'math') {
        maxQuestions = 22;
        document.getElementById('test-duration').value = 35;
    } else {
        maxQuestions = 27;
        document.getElementById('test-duration').value = 32;
    }
    
    document.getElementById('max-questions').textContent = maxQuestions;
    updateQuestionCount();
    
    document.getElementById('test-modal').classList.add('show');
}

async function deleteTestSet(title) {
    if (!confirm(`Are you sure you want to delete all tests with title "${title}"?`)) return;
    
    try {
        const response = await fetch('/api/tests/');
        const result = await response.json();
        const toDelete = result.data.filter(t => t.title === title);
        
        for (const test of toDelete) {
            await fetch(`/api/tests/${test.id}/delete/`, { method: 'DELETE' });
        }
        loadTests();
    } catch (error) {
        console.error('Error deleting test set:', error);
    }
}

async function deleteQuestionFromTest(testId, questionIndex) {
    if (!confirm('Are you sure you want to delete this question?')) return;
    
    try {
        const response = await fetch(`/api/tests/${testId}/`);
        const test = await response.json();
        
        // Wait, api_test_detail doesn't return questions currently in the Read output.
        // I need to update api_test_detail in views.py to return questions.
    } catch (error) {
        console.error('Error deleting question:', error);
    }
}

async function editTest(testId) {
    try {
        const response = await fetch(`/api/tests/${testId}/`);
        const test = await response.json();
        
        selectedSubject = test.category;
        selectedModule = test.test_type;
        maxQuestions = test.category === 'math' ? 22 : 27;
        
        document.getElementById('modal-title').textContent = `Edit Test - ${test.title}`;
        document.getElementById('test-id').value = test.id;
        document.getElementById('test-title').value = test.title;
        document.getElementById('test-description').value = test.description || '';
        document.getElementById('test-category').value = test.category;
        document.getElementById('test-module').value = test.test_type;
        document.getElementById('test-difficulty').value = test.difficulty;
        document.getElementById('test-duration').value = test.duration;
        document.getElementById('test-active').value = test.is_active.toString();
        
        const container = document.getElementById('questions-container');
        container.innerHTML = '';
        questionCount = 0;
        
        if (test.questions && test.questions.length > 0) {
            test.questions.forEach(q => {
                addQuestionWithData(q);
            });
        }
        
        document.getElementById('max-questions').textContent = maxQuestions;
        updateQuestionCount();
        
        document.getElementById('test-modal').classList.add('show');
    } catch (error) {
        console.error('Error loading test:', error);
    }
}

function addQuestionWithData(data) {
    questionCount++;
    const container = document.getElementById('questions-container');
    const showImageUpload = selectedSubject === 'math';
    
    const questionHtml = `
        <div class="question-item" data-question="${questionCount}">
            <div class="question-item-header">
                <span class="question-number">Question ${questionCount}</span>
                <button type="button" class="delete-question-btn" onclick="deleteQuestion(this)">
                    <i class="fas fa-trash"></i>
                </button>
            </div>
            <textarea class="question-text-input" placeholder="Enter question text..." rows="2" required>${data.text || data.question_text || ''}</textarea>
            ${showImageUpload ? `
            <div class="image-upload-section ${data.image ? 'has-image' : ''}">
                <label class="image-upload-label">
                    <i class="fas fa-image"></i>
                    <span>Add image (optional for math symbols)</span>
                    <input type="file" class="image-upload-input" accept="image/*" onchange="handleImageUpload(this)">
                </label>
                <div class="image-preview">
                    ${data.image ? `<img src="${data.image}" alt="Question image"><button type="button" class="remove-image-btn" onclick="removeImage(this)"><i class="fas fa-times"></i></button>` : ''}
                </div>
            </div>
            ` : ''}
            <div class="options-grid">
                ${['A', 'B', 'C', 'D'].map(label => {
                    const option = data.options ? data.options.find(o => o.label === label) : null;
                    const isCorrect = data.correct_answer === label;
                    const optText = option ? option.text : (data[`option_${label.toLowerCase()}`] || '');
                    
                    return `
                    <div class="option-item">
                        <input type="radio" name="correct_${questionCount}" value="${label}" class="option-radio" ${isCorrect ? 'checked' : ''} required>
                        <span class="option-label">${label})</span>
                        <input type="text" class="option-input" placeholder="Option ${label}" value="${optText}" required>
                    </div>`;
                }).join('')}
            </div>
        </div>
    `;
    
    container.insertAdjacentHTML('beforeend', questionHtml);
}

async function deleteQuestionFromTest(testId, questionIndex) {
    if (!confirm('Are you sure you want to delete this question from the test?')) return;
    
    try {
        const response = await fetch(`/api/tests/${testId}/`);
        const test = await response.json();
        
        const newQuestions = test.questions.filter((_, idx) => idx !== questionIndex);
        
        await fetch(`/api/tests/${testId}/`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
                questions: newQuestions,
                questions_count: newQuestions.length
            })
        });
        
        loadTests();
    } catch (error) {
        console.error('Error deleting question:', error);
    }
}

async function saveTest(e) {
    e.preventDefault();
    const testId = document.getElementById('test-id').value;
    
    const questions = [];
    document.querySelectorAll('.question-item').forEach((item, index) => {
        const questionText = item.querySelector('.question-text-input').value;
        const options = [];
        let correctAnswer = '';
        
        item.querySelectorAll('.option-item').forEach(opt => {
            const radio = opt.querySelector('.option-radio');
            const input = opt.querySelector('.option-input');
            const label = opt.querySelector('.option-label').textContent.replace(')', '');
            
            options.push({
                label: label,
                text: input.value
            });
            
            if (radio.checked) {
                correctAnswer = label;
            }
        });
        
        const imagePreview = item.querySelector('.image-preview img');
        const imageData = imagePreview ? imagePreview.src : null;
        
        questions.push({
            order: index + 1,
            text: questionText,
            options: options,
            correct_answer: correctAnswer,
            image: imageData
        });
    });
    
    const data = {
        title: document.getElementById('test-title').value.trim(),
        description: document.getElementById('test-description').value,
        category: document.getElementById('test-category').value,
        test_type: document.getElementById('test-module').value,
        difficulty: document.getElementById('test-difficulty').value,
        duration: parseInt(document.getElementById('test-duration').value),
        questions_count: questions.length,
        is_active: document.getElementById('test-active').value === 'true',
        questions: questions
    };
    
    try {
        const url = testId ? `/api/tests/${testId}/` : '/api/tests/create/';
        const response = await fetch(url, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(data)
        });
        
        const result = await response.json();
        
        if (result.success) {
            // Check for pairing
            const allTestsResp = await fetch('/api/tests/');
            const allTests = await allTestsResp.json();
            const sameTitleTests = allTests.data.filter(t => t.title === data.title);
            
            const hasEnglish1 = sameTitleTests.some(t => t.test_type === 'english_module1');
            const hasEnglish2 = sameTitleTests.some(t => t.test_type === 'english_module2');
            const hasMath1 = sameTitleTests.some(t => t.test_type === 'math_module1');
            const hasMath2 = sameTitleTests.some(t => t.test_type === 'math_module2');
            
            if (!hasEnglish1 || !hasEnglish2 || !hasMath1 || !hasMath2) {
                const missing = [];
                if (!hasEnglish1) missing.push('English Module 1');
                if (!hasEnglish2) missing.push('English Module 2');
                if (!hasMath1) missing.push('Math Module 1');
                if (!hasMath2) missing.push('Math Module 2');
                
                alert(`Test saved! Note: This test set is still INCOMPLETE. Missing: ${missing.join(', ')}. Users won't be able to take the full exam until all modules are added.`);
            } else {
                alert('Success! Full test set is now complete and ready for users.');
            }
        }
        
        closeAllModals();
        loadTests();
    } catch (error) {
        console.error('Error saving test:', error);
    }
}

async function deleteTest(testId) {
    if (!confirm('Are you sure you want to delete this test?')) return;
    
    try {
        await fetch(`/api/tests/${testId}/delete/`, { method: 'DELETE' });
        loadTests();
    } catch (error) {
        console.error('Error deleting test:', error);
    }
}
</script>
{% endblock %}
